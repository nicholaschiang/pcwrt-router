function add_field_error(t,r){var e=t.parent();e.hasClass("input-group")&&(e=e.parent()),e.addClass("has-error").append('<p class="form-control-error">'+r+"</p>")}function is_valid_ip(e,a){var s=!1;return $.each(fv.ifaces,function(t,r){if(is_ip_on_network(e,r.ipaddr,r.netmask,a))return!(s=!0)}),s}function get_lan_if(){var e=null;return $.each(fv.ifaces,function(t,r){if("lan"==r.name)return e=r,!1}),e}function is_lan_ip(t){var r=get_lan_if();return!!r&&is_ip_on_network(t,r.ipaddr,r.netmask)}function get_new_ip(t,r,e){if("string"!=typeof t||"string"!=typeof r||"string"!=typeof e)return e;if(!pcwrt.is_valid_ipaddr(t)||!pcwrt.is_valid_ipaddr(r)||!pcwrt.is_valid_ipaddr(e))return e;for(var a=t.split("."),s=r.split("."),o=e.split("."),i=[a[0]&s[0],a[1]&s[1],a[2]&s[2],a[3]&s[3]],n=[255,255,255,255],d=0;d<4;d++)n[d]=(n[d]^s[d])&o[d];for(var d=0;d<4;d++)i[d]+=n[d];return i.join(".")}function merge_hosts(){var e=[];$.each(fv.leases,function(t,r){r.idx||(r.orig_hostname&&(r.hostname=r.orig_hostname),r.orig_ipaddr&&(r.ipaddr=r.orig_ipaddr),e.push(r))}),fv.leases=e;var a=fv.leases.length;$("#hosts tr:gt(0)").each(function(t){for(var r=!1,e=0;e<a;e++)if(fv.leases[e].macaddr.toUpperCase()==$("td:first",$(this)).text().trim().toUpperCase()){fv.leases[e].orig_ipaddr=fv.leases[e].ipaddr,fv.leases[e].orig_hostname=fv.leases[e].hostname,fv.leases[e].ipaddr=$("td:eq(1)",$(this)).text().trim(),fv.leases[e].hostname=$("td:eq(2)",$(this)).text().trim(),r=!0;break}r||fv.leases.push({hostname:$("td:eq(2)",$(this)).text().trim(),macaddr:$("td:first",$(this)).text().trim(),ipaddr:$("td:eq(1)",$(this)).text().trim(),idx:t+1})}),fv.leases.sort(function(t,r){return t.hostname.toUpperCase()>r.hostname.toUpperCase()?1:-1});var s=[];$.each(fv.leases,function(t,r){s.push({value:r.hostname,text:r.hostname})}),$("#host-name").updatecombo(s),update_forward_hosts()}function update_forward_hosts(){var r=[],e=get_new_ip($("#ipaddr").val(),$("#netmask").val(),fv.ipaddr)+" (Router)";r.push({value:e,text:e}),$("#hosts tr:gt(0)").each(function(t){is_valid_ip(e=$("td:eq(1)",$(this)).text().trim(),!1)&&(e+=" ("+$("td:eq(2)",$(this)).text().trim()+")",r.push({value:e,text:e}))}),$("#forward-dest_ip").updatecombo(r)}function add_options(e,t){$.each(t,function(t,r){e.append($("<option/>").attr("value",r.value).text(r.text))})}$(function(){$("label.required").add_required_mark(window.msgs.required),$("label.control-label[data-hint]").init_hint(),$("input[data-units]").makeunit();for(var t=0;t<fv.vlans.ports.length;t++){var r=fv.vlans.ports[t].port;$("#vlan-ports").append('<div class="form-group col-md-2"><label class="control-label" for="port-'+r+'">'+window.msgs.port+" "+(t+1)+'</label><select class="form-control" id="port-'+r+'" name="port-'+r+'"></select></div>')}for(var t=0;t<fv.vlans.ports.length;t++){var r=fv.vlans.ports[t].port;add_options($("[name=port-"+r+"]"),fv.vlans.options)}$("select").makecombo();for(var t=0;t<fv.vlans.ports.length;t++){var r=fv.vlans.ports[t].port;$("[name=port-"+r+"]").val(fv.vlans.ports[t].id)}null!=fv.dnsrebind&&$("[name=dnsrebind]").parent().parent().show(),pcwrt.populate_forms(),$("#host-name").on("selection.change",function(t,r){$("#host-mac").val(fv.leases[r].macaddr);var e=is_lan_ip(fv.leases[r].ipaddr)?get_new_ip($("#ipaddr").val(),$("#netmask").val(),fv.leases[r].ipaddr):fv.leases[r].ipaddr;$("#host-ip").val(e)}),$("#forward-name").on("selection.change",function(t,r){var e=$("#forwards tr:eq("+(r+1)+")");$("#forward-proto").val($("td:eq(1)",e).text().trim()),$("#forward-src_dport").val($("td:eq(2)",e).text().trim()),$("#forward-dest_ip").val($("td:eq(3)",e).text().trim()),$("#forward-dest_port").val($("td:eq(4)",e).text().trim())}),fv.hostname_lookup={},$.each(fv.hosts.sort(function(t,r){return t.name.toUpperCase()==r.name.toUpperCase()?t.mac.toUpperCase()>r.mac.toUpperCase()?1:-1:t.name.toUpperCase()>r.name.toUpperCase()?1:-1}),function(t,r){fv.hostname_lookup[r.ip]=r.name,$("#hosts").append('<tr><td class="mac-addr">'+r.mac+"</td><td>"+r.ip+'</td><td><span class="list-remove pull-right">&nbsp;</span>'+r.name+"</td></tr>")}),$.each(fv.leases,function(t,r){r.hostname||(r.hostname="*unknown*")}),merge_hosts(),$.each(fv.routes,function(t,r){$("#routes").append("<tr><td>"+r.interface+"</td><td>"+r.target+"</td><td>"+r.netmask+"</td><td>"+r.gateway+'</td><td><span class="list-remove pull-right">&nbsp;</span>'+r.metric+"</td></tr>")}),$.each(fv.forwards,function(t,r){$("#forwards").append("<tr><td>"+r.name+"</td><td>"+r.proto+"</td><td>"+r.src_dport+"</td><td>"+(fv.hostname_lookup[r.dest_ip]?r.dest_ip+" ("+fv.hostname_lookup[r.dest_ip]+")":r.dest_ip)+'</td><td><span class="list-remove pull-right">&nbsp;</span>'+r.dest_port+"</td></tr>")}),$("#hosts").on("click","span.list-remove",function(){$(this).parent().parent().remove(),merge_hosts()}),$("#routes,#forwards").on("click","span.list-remove",function(){$(this).parent().parent().remove()}),/applyreboot/.test(document.referrer)&&($("#status-modal .modal-title").text(window.msgs.success),$("#status-modal .modal-body p").text(window.msgs.apply_success),$("#status-modal").modal("show")),$("button.add-dialog").on("click",function(t){t.preventDefault();var r=$(this).parent().prev().find("table").attr("id")+"-modal";$("#"+r).find("p.form-control-error").parent().removeClass("has-error").end().remove().end().modal("show")}),$("#hosts-modal").on("show.bs.modal",function(){$("#host-name,#host-ip,#host-mac").val("")}),$("#forwards-modal").on("show.bs.modal",function(){var e=[];$("#forwards tr:gt(0)").each(function(t){var r=$("td:first",$(this)).text();e.push({value:r,text:r})}),$("#forward-name").updatecombo(e),$("input",$(this)).val("")}),$("#hosts-modal button.btn-success").on("click",function(t){t.preventDefault(),$("#hosts-modal p.form-control-error").parent().removeClass("has-error").end().remove();var r=!0,e=-1;function a(){0<e?$("td","#hosts tr:eq("+e+")").each(function(t){1==t?$(this).text($("#host-ip").val()):2==t&&$(this).html('<span class="list-remove pull-right">&nbsp;</span>'+$("#host-name").val()+"</td>")}):$("#hosts").append('<tr><td class="mac-addr">'+$("#host-mac").val()+"</td><td>"+$("#host-ip").val()+'</td><td><span class="list-remove pull-right">&nbsp;</span>'+$("#host-name").val()+"</td></tr>"),merge_hosts(),$("#hosts-modal").find("input:visible").val("").end().modal("hide")}pcwrt.is_valid_macaddr($("#host-mac").val())?$("#hosts tr:gt(0)").each(function(t){if($("td:first",$(this)).text().trim().toUpperCase()==$("#host-mac").val().toUpperCase())return e=t+1,!1}):(r=!1,add_field_error($("#host-mac"),msgs.invalid_mac)),pcwrt.is_valid_ipaddr($("#host-ip").val())&&is_valid_ip($("#host-ip").val(),!0)||(r=!1,add_field_error($("#host-ip"),msgs.invalid_ip)),pcwrt.is_valid_hostname($("#host-name").val())||(r=!1,add_field_error($("#host-name"),msgs.invalid_host));var s=-1;if($("#hosts tr:gt(0)").each(function(t){if($("td:eq(2)",$(this)).text().trim().toUpperCase()==$("#host-name").val().toUpperCase()&&$("td:first",$(this)).text().trim().toUpperCase()!=$("#host-mac").val().toUpperCase())return s=t+1,!1}),0<s){var o="Do you want to add MAC address "+$("#host-mac").val()+" to "+$("#hosts tr:eq("+s+") td:eq(2)").text().trim()+"?";pcwrt.confirm_action("Confirmation",o,function(){$("#host-ip").val($("#hosts tr:eq("+s+") td:eq(1)").text().trim()),$("#host-name").val($("#hosts tr:eq("+s+") td:eq(2)").text().trim()),a()})}else $("#hosts tr:gt(0)").each(function(){if($("td:eq(1)",$(this)).text().trim()==$("#host-ip").val()&&$("td:first",$(this)).text().trim().toUpperCase()!=$("#host-mac").val().toUpperCase())return r=!1,add_field_error($("#host-ip"),msgs.duplicate_ip),!1}),r&&a()}),$("#routes-modal button.btn-success").on("click",function(t){t.preventDefault(),$("#routes-modal p.form-control-error").parent().removeClass("has-error").end().remove();var r=!0;$("#route-target,#route-netmask,#route-gateway").each(function(){pcwrt.is_valid_ipaddr($(this).val())||(r=!1,add_field_error($(this),msgs["invalid_"+$(this).attr("name")]))}),pcwrt.is_number($("#route-metric").val())||(r=!1,add_field_error($("#route-metric"),msgs.invalid_metric)),r&&($("#routes").append("<tr><td>"+$("#route-interface").val()+"</td><td>"+$("#route-target").val()+"</td><td>"+$("#route-netmask").val()+"</td><td>"+$("#route-gateway").val()+'</td><td><span class="list-remove pull-right">&nbsp;</span>'+$("#route-metric").val()+"</td></tr>"),$("#routes-modal").find("input:visible").val("").end().modal("hide"))}),$("#forwards-modal button.btn-success").on("click",function(t){t.preventDefault(),$("#forwards-modal p.form-control-error").parent().removeClass("has-error").end().remove();var r=!0,e=-1;$("#forwards tr:gt(0)").each(function(t){if($("td:first",$(this)).text().trim()==$("#forward-name").val().trim())return e=t+1,!1}),""==$("#forward-proto").val().trim()&&(r=!1,add_field_error($("#forward-proto"),msgs.missing_proto)),$("#forward-dest_port,#forward-src_dport").each(function(){pcwrt.is_valid_port($(this).val())||pcwrt.is_valid_port_range($(this).val())||(r=!1,add_field_error($(this),msgs.invalid_port))});var a=$("#forward-dest_ip").val().replace(/\s*\(.*\)/,"");pcwrt.is_valid_ipaddr(a)&&is_valid_ip(a,!1)||(r=!1,add_field_error($("#forward-dest_ip"),msgs.invalid_ip)),r&&(0<e?$("td","#forwards tr:eq("+e+")").each(function(t){switch(t){case 1:$(this).text($("#forward-proto").val());break;case 2:$(this).text($("#forward-src_dport").val());break;case 3:$(this).text($("#forward-dest_ip").val());break;case 4:$(this).html('<span class="list-remove pull-right">&nbsp;</span>'+$("#forward-dest_port").val())}}):$("#forwards").append("<tr><td>"+$("#forward-name").val()+"</td><td>"+$("#forward-proto").val()+"</td><td>"+$("#forward-src_dport").val()+"</td><td>"+$("#forward-dest_ip").val()+'</td><td><span class="list-remove pull-right">&nbsp;</span>'+$("#forward-dest_port").val()+"</td></tr>"),$("#forwards-modal").find("input:visible").val("").end().modal("hide"))}),$("#ipaddr,#netmask").on("change",function(t){$("#hosts tr:gt(0)").each(function(){var t=$("td:eq(1)",$(this)).text().trim();is_lan_ip(t)&&$("td:eq(1)",$(this)).text(get_new_ip($("#ipaddr").val(),$("#netmask").val(),t))}),$("#forwards tr:gt(0)").each(function(){var t=$("td:eq(3)",$(this)).text().trim(),r=t.replace(/\s*\(.*\)/,"");is_lan_ip(r)&&$("td:eq(3)",$(this)).text(t.replace(r,get_new_ip($("#ipaddr").val(),$("#netmask").val(),r)))});var r=get_lan_if();r.ipaddr=$("#ipaddr").val(),r.netmask=$("#netmask").val(),update_forward_hosts()}),$('button[type="submit"]').on("click",function(t){t.preventDefault();var r=$(this).parents("form"),e=r.serializeArray(),a=[];$("#vlan-ports input[name*=port-]").each(function(){a.push({port:$(this).attr("name").replace("port-",""),id:$(this).val()})}),e.push({name:"vlans",value:JSON.stringify(a)});var s=["mac","ip","name"],o=[];$("#hosts tr:gt(0)").each(function(){var r=new Object;$("td",$(this)).each(function(t){r[s[t]]=$(this).text().trim()}),o.push(r)}),e.push({name:"hosts",value:JSON.stringify(o)});var i=["interface","target","netmask","gateway","metric"],n=[];$("#routes tr:gt(0)").each(function(){var r=new Object;$("td",$(this)).each(function(t){r[i[t]]=$(this).text().trim()}),n.push(r)}),e.push({name:"routes",value:JSON.stringify(n)});var d=["name","proto","src_dport","dest_ip","dest_port"],p=[];$("#forwards tr:gt(0)").each(function(){var r=new Object;$("td",$(this)).each(function(t){r[d[t]]=3==t?$(this).text().trim().replace(/\s*\(.*\)/,""):$(this).text().trim()}),p.push(r)}),e.push({name:"forwards",value:JSON.stringify(p)}),pcwrt.submit_form(r,e,function(t){t.reboot?($("#spinner strong").html(window.msgs.rebooting),pcwrt.showOverlay($("#spinner")),$("<iframe/>",{src:t.reload_url+"?addr="+t.addr}).appendTo("#reloader")):null==t.apply?(pcwrt.showOverlay($("#spinner")),$("<iframe/>",{src:t.reload_url+"?addr="+t.addr+"&page=settings%2Fnetwork"}).appendTo("#reloader")):(fv.ifaces=t.ifaces,$("#hosts tr:gt(0)").each(function(t){var r;is_valid_ip($("td:eq(1)",$(this)).text().trim(),!0)||$(this).remove()}),$("#forwards tr:gt(0)").each(function(t){var r;is_valid_ip($("td:eq(3)",$(this)).text().trim().replace(/\s*\(.*\)/,""),!1)||$(this).remove()}),pcwrt.apply_changes(t.apply))})})});