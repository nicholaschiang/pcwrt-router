function display_disabled(){$("#ipsec-status").text(msgs.disabled).parent().removeClass("alert-success").addClass("alert-danger"),$("#enable-ipsec").removeClass("hidden"),$("#disable-ipsec").addClass("hidden"),$("#restart-ipsec").addClass("hidden"),$("#ipsec-settings").slideUp()}function disable_ipsec(e){pcwrt.submit_form(e,JSON.stringify({enabled:"0"}),function(e){display_disabled(),pcwrt.apply_changes(e.apply)})}function toggle_ipsec_auth_type(){"ikev2"==$("#auth-modal [name=ipsec_type]:checked").val()?($("#ikev2-auth-conf").show(),$("#ikev1-auth-conf").hide(),"p12"==$("#auth-modal [name=cert_type]:checked").val()?($("#p12-certs").show(),$("#pem-certs").hide()):($("#p12-certs").hide(),$("#pem-certs").show())):($("#ikev1-auth-conf").show(),$("#ikev2-auth-conf").hide())}function showAddAuthModal(){$("#auth-modal").find(".modal-title").text(window.msgs.add_ipsec_auth_title).end().find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end().find("input:not([type=radio],[type=checkbox])").val("").end().modal("show"),toggle_ipsec_auth_type()}function update_auth_config_select(){var e=[];e.push({value:"",text:window.msgs.select_auth_config}),$("#auth-configs tr:gt(0)").each(function(){if($(this).is(":last-child"))return!1;e.push({value:$("td",this).text().trim(),text:$("td",this).text().trim()})}),$("#authconfig").updatecombo(e)}function is_equivalent_name(e,t){return null!=e&&null!=t&&(e=e.replace(/[^0-9-a-zA-Z.]/g,"-"))==(t=t.replace(/[^0-9-a-zA-Z.]/g,"-"))}function update_ipsec_auth(e){var t;$("#auth-configs tr:gt(0)").each(function(){return!$(this).is(":last-child")&&($("#auth-modal input[name=oldname]").val()==$(this).data("oldname")?(t=$(this),!1):void 0)}),t?$("td",t).html('<span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span>'+$("#cfgname").val().trim()):(t=$('<tr><td><span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span>'+$("#cfgname").val().trim()+"</td></tr>"),$("#auth-configs tr:last").before(t));var a=t.data("oldname"),s=$("#cfgname").val().trim();$("#ipsec-conns tr:gt(0)").each(function(){if($(this).is(":last-child"))return!1;$(this).data("authconfig")==a&&$(this).data("authconfig",s)});var n=$("#auth-modal [name=ipsec_type]:checked").val();t.data("oldname",s),t.data("ipsec_type",n),"ikev1"==n?(t.data("psk",$("#ikev1-psk").val().trim()),t.data("cfguser",$("#ikev1-user").val().trim()),t.data("cfgpass",$("#ikev1-pass").val().trim())):(t.data("cfguser",$("#cfguser").val().trim()),t.data("cfgpass",$("#cfgpass").val().trim())),e&&(t.data("cadn",e.cadn),t.data("clidn",e.clidn)),update_auth_config_select(),$("#auth-configs").data("uncommitted",!0)}function update_ipsec_conn(){var e;$("#ipsec-conns tr:gt(0)").each(function(){return!$(this).is(":last-child")&&($("#conn-modal input[name=oldconnname]").val()==$(this).data("oldconnname")?(e=$(this),!1):void 0)}),e?$("td:first",e).html('<span class="glyphicon glyphicon-play pull-right control" title="Start"></span><span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span><span class="glyphicon glyphicon-list-alt pull-right logs" title="View log" style="display:none"></span>'+$("#connname").val().trim()):(e=$('<tr><td><span class="glyphicon glyphicon-play pull-right control" title="Start"></span><span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span><span class="glyphicon glyphicon-list-alt pull-right logs" title="View log" style="display:none"></span>'+$("#connname").val().trim()+'</td><td class="text-center"><input type="checkbox" name="autostart"></td></tr>'),$("#ipsec-conns tr:last").before(e)),e.data("oldconnname",$("#connname").val().trim()),e.data("connhost",$("#connhost").val().trim()),e.data("authconfig",$("#authconfig").val().trim()),$("#ipsec-conns").data("uncommitted",!0)}function validate_ikev1_auth(){var e=!0;return pcwrt.is_empty($("#ikev1-psk").val())&&($("#ikev1-psk").after('<p class="form-control-error">'+window.msgs.enter_psk+"</p>").parent().addClass("has-error"),e=!1),/^[a-zA-Z0-9._\-\\\$@%#&]+$/.test($("#ikev1-user").val())||($("#ikev1-user").after('<p class="form-control-error">'+window.msgs.enter_valid_user_name+"</p>").parent().addClass("has-error"),e=!1),pcwrt.is_empty($("#ikev1-pass").val())&&($("#ikev1-pass").after('<p class="form-control-error">'+window.msgs.enter_password+"</p>").parent().addClass("has-error"),e=!1),e}$("#auth-modal [name=ipsec_type]").on("click",function(e){toggle_ipsec_auth_type()}),$("#user-dialog [name=ipsec_type]").on("click",function(e){"ikev1"==$(this).val()?$("#password").parent().show():$("#password").parent().hide()}),$("#gen-passwd").on("click",function(e){e.preventDefault(),$("#password").val(random_string("ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz",12))}),$('#ipsec-init button[type="submit"]').on("click",function(e){e.preventDefault();var t=$(this).parents("form");pcwrt.submit_form(t,{},function(e){$("#init-alert").addClass("hidden").next().hide(),$("#prog-alert").removeClass("hidden")})}),$("#reinit-ipsec").on("click",function(e){e.preventDefault(),pcwrt.confirm_action(window.msgs.reinit_ipsec_title,window.msgs.reinit_ipsec_confirm,function(){pcwrt.submit_form($("#ipsec-init"),{},function(e){$("#main-form").hide(),$("#prog-alert").removeClass("hidden")})})}),$("[name=cert_type]").on("click",function(e){toggle_ipsec_auth_type()}),$("#ipsec-conns").on("click","input",function(e){$(this).prop("checked")&&$(this).parent().parent().siblings().find("input[type=checkbox]").prop("checked",!1)}),$("#users .btn").on("click",function(e){e.preventDefault(),$("#user-dialog .form-group").removeClass("has-error").find("p.form-control-error").remove(),$("#user-dialog [name=ipsec_type][value=ikev2]").prop("checked",!0),$("#password").val("").parent().hide(),$("#user-dialog").data("rowidx",null).modal("show"),$("#username").val("").focus(),$("[name=vpnout]:first").prop("checked",!0)}),$("#users").on("click",".list-edit",function(e){e.preventDefault();var t=$(this).parents("tr:first");$("#user-dialog [name=ipsec_type][value="+t.data("type")+"]").prop("checked",!0),$("#password").val(t.data("password")),$("#user-dialog .form-group").removeClass("has-error").find("p.form-control-error").remove(),$("#user-dialog").data("rowidx",t.index()).modal("show"),"ikev1"==t.data("type")?$("#password").parent().show():$("#password").parent().hide(),$(this).parent().next().text()==window.msgs.vpn?$("[name=vpnout]:eq(1)").prop("checked",!0):$("[name=vpnout]:eq(0)").prop("checked",!0),$("#username").val($("td:first",t).text().trim()).focus()}),$("#user-dialog .btn-success").on("click",function(e){e.preventDefault(),$("#user-dialog .form-group").removeClass("has-error").find("p.form-control-error").remove();var t="";if(/^[a-zA-Z0-9._\-\\\$@%#&]+$/.test($("#username").val())||($("#username").after('<p class="form-control-error">'+window.msgs.enter_valid_user_name+"</p>").parent().addClass("has-error"),t+=" username"),"ikev1"==$("#user-dialog [name=ipsec_type]:checked").val()&&pcwrt.is_empty($("#password").val())&&($("#password").after('<p class="form-control-error">'+window.msgs.enter_password+"</p>").parent().addClass("has-error"),t+=" password"),!t){t=null;var a=$("#user-dialog").data("rowidx");if($("#users tr:gt(0)").each(function(){$(this).is(":last-child")||$(this).index()!=a&&is_equivalent_name($("td",$(this)).text().trim(),$("#username").val())&&(t="duplicate")}),"duplicate"!=t){var s=$("#user-dialog [name=ipsec_type]:checked").val(),n='<tr><td><span class="pull-right list-remove" title="Delete user">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span>',i;if("ikev2"==s&&(n+='<span class="pull-right glyphicon glyphicon-download-alt control" title="Download user certificate"></span>'),n+=$("#username").val().trim()+"</td><td>"+("1"==$("[name=vpnout]:checked").val()?window.msgs.vpn:window.msgs.isp)+'</td><td class="text-center"><input type="checkbox" name="guest"></td></tr>',null!=a){i=$("#users tr:eq("+a+")");var o=$("[name=guest]",i).prop("checked");i.replaceWith(n),i=$("#users tr:eq("+a+")"),$("[name=guest]",i).prop("checked",o)}else i=$(n),$("#users tr:last").before(i);i.data("type",s),i.data("username",$("#username").val().trim()),"ikev1"==s?i.data("password",$("#password").val()):i.data("password",null),$("#user-dialog").modal("hide")}else $("#username").after('<p class="form-control-error">'+window.msgs.user_name_exists+"</p>").parent().addClass("has-error")}}),$("#users").on("click",".list-remove",function(e){e.preventDefault(),$("#users").data("deleteUser",$(this).parents("tr").index()),pcwrt.confirm_action(window.msgs.delete_user_title,window.msgs.delete_user_confirm+' "'+$(this).parent().text().trim()+'"?',function(){var e=$("#users").data("deleteUser");$("#users tr:eq("+e+")").remove()})}),$("#users").on("click",".glyphicon-download-alt",function(e){e.preventDefault();var t=$(this).parent().parent().data("username");if(t){$("#download-cert [name=user]").val(t);var a=$("#download-cert").serializeArray();a.push({name:"status",value:!0}),pcwrt.submit_form($("#download-cert"),a,function(e){"ready"==e.cert_status?$("#p12-password").find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end().find("#p12password").val("").end().modal("show"):"in_progress"==e.cert_status?pcwrt.show_message(msgs.user_cert_in_progress_title,msgs.user_cert_in_progress):pcwrt.show_message(msgs.user_cert_missing_title,msgs.user_cert_missing)})}else pcwrt.show_message(msgs.user_not_saved_title,msgs.user_not_saved)}),$("#p12-password .btn-success").on("click",function(e){e.preventDefault(),$("#p12-password").find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end(),/^[a-zA-Z0-9._\-\\\$@%#&]*$/.test($("#p12password").val())?($("#download-cert [name=password]").val($("#p12password").val()),$("#p12-password").modal("hide"),window.location.href=$("#download-cert").attr("action")+"?"+$("#download-cert").serialize()):$("#p12password").after('<p class="form-control-error">'+window.msgs.enter_valid_password+"</p>").parent().addClass("has-error")}),$("#create-auth-config,#add-ipsec-auth").on("click",function(e){e.preventDefault(),showAddAuthModal()}),$("#download-rootca").on("click",function(e){e.preventDefault(),window.location.href=$("#download-cacert").attr("action")}),$("#add-ipsec-conn").on("click",function(e){e.preventDefault(),$("#conn-modal").find(".modal-title").text(window.msgs.add_ipsec_conn_title).end().find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end().find("input:not([type=radio],[type=checkbox])").val("").end().modal("show")}),$("#conn-modal .btn-success").on("click",function(e){e.preventDefault(),$("#conn-modal .form-group").removeClass("has-error").find("p").remove();var t=!0;pcwrt.is_empty($("#connname").val())?($("#conn-modal .form-group:first").addClass("has-error").append('<p class="form-control-error">'+window.msgs.empty_conn_name+"</p>"),t=!1):$("#ipsec-conns tr:gt(0)").each(function(){return!$(this).is(":last-child")&&($("#oldconnname").val()!=$(this).data("oldconnname")&&is_equivalent_name($(this).data("oldconnname"),$("#connname").val().trim())?($("#conn-modal .form-group:first").addClass("has-error").append('<p class="form-control-error">'+window.msgs.duplicate_conn+"</p>"),t=!1):void 0)}),pcwrt.is_valid_hostname($("#connhost").val())||pcwrt.is_valid_ipaddr($("#connhost").val())||($("#conn-modal .form-group:eq(1)").addClass("has-error").append('<p class="form-control-error">'+window.msgs.empty_host_name+"</p>"),t=!1),pcwrt.is_empty($("#authconfig").val())&&($("#conn-modal .form-group:eq(2)").addClass("has-error").append('<p class="form-control-error">'+window.msgs.empty_auth_config+"</p>"),t=!1),t&&(update_ipsec_conn(),$("#conn-modal").modal("hide"))}),$("#auth-configs").on("click",".list-remove",function(e){e.preventDefault();var t=!1,a=$(this).parent().text().trim();$("#ipsec-conns tr:gt(0)").each(function(){return!$(this).is(":last-child")&&($(this).data("authconfig")==a?(t=$("td:first",$(this)).text().trim(),pcwrt.show_message(window.msgs.delete_auth_config_cannot_title,window.msgs.delete_auth_config_cannot+" '"+a+"', "+window.msgs.delete_auth_config_used+" '"+t+"'."),!1):void 0)}),t||($("#auth-configs").data("deleteConfig",$(this).parents("tr").index()),pcwrt.confirm_action(window.msgs.delete_auth_config_title,window.msgs.delete_auth_config_confirm+' "'+a+'"?',function(){var e=$("#auth-configs").data("deleteConfig");$("#auth-configs tr:eq("+e+")").remove(),update_auth_config_select(),$("#auth-configs").data("uncommitted",!0)}))}),$("#auth-configs").on("click",".list-edit",function(e){e.preventDefault(),$("#auth-modal").find(".modal-title").text(window.msgs.edit_ipsec_auth_title).end().find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end().find("input:not([type=radio],[type=checkbox])").val("").end();var t=$(this).parent().parent(),a;"ikev1"==t.data("ipsec_type")?$("#auth-modal").find("[name=ipsec_type][value=ikev1]").prop("checked",!0).end().find("input[name=username]").val(t.data("cfguser")).end().find("input[name=password]").val(t.data("cfgpass")).end().find("input[name=psk]").val(t.data("psk")):($("#auth-modal").find("[name=ipsec_type][value=ikev2]").prop("checked",!0).end().find("[name=cert_type][value=pem]").prop("checked",!0).end().find("input[name=cfguser]").val(t.data("cfguser")).end().find("input[name=cfgpass]").val(t.data("cfgpass")),t.data("cadn")&&$("#auth-modal").find("[name=cacert-name]").val(t.data("cadn")),t.data("clidn")&&$("#auth-modal").find("[name=clicert-name]").val(t.data("clidn"))),$("#auth-modal").find("input[name=cfgname]").val($(this).parent().text().trim()).end().find("input[name=oldname]").val(t.data("oldname")).end().modal("show"),toggle_ipsec_auth_type()}),$("#auth-modal .btn-file:first :file").on("fileselect",function(e,t,a){$("#auth-modal [name=p12-name]").val(a)}),$("#auth-modal .btn-file:eq(1) :file").on("fileselect",function(e,t,a){$("#auth-modal [name=cacert-name]").val(a)}),$("#auth-modal .btn-file:eq(2) :file").on("fileselect",function(e,t,a){$("#auth-modal [name=clicert-name]").val(a)}),$("#auth-modal .btn-file:eq(3) :file").on("fileselect",function(e,t,a){$("#auth-modal [name=clikey-name]").val(a)}),$("#auth-modal form").ajaxForm({beforeSubmit:function(e,t,a){$("#auth-modal .form-control-error").parent().removeClass("has-error").end().remove();var s=t[0].cfgname.value.trim(),n;if(!s)return $("#auth-modal form .form-group:first").addClass("has-error").append('<p class="form-control-error">'+window.msgs.empty_config+"</p>"),!1;if("ikev1"==$("#auth-modal [name=ipsec_type]:checked").val())return validate_ikev1_auth()&&(update_ipsec_auth(),$("#auth-modal").modal("hide")),!1;var i=!0;return $("#auth-configs tr:gt(0)").each(function(){return!$(this).is(":last-child")&&(t[0].oldname.value!=$(this).data("oldname")&&is_equivalent_name($("td:first",$(this)).text().trim(),s)?($("#auth-modal form .form-group:first").addClass("has-error").append('<p class="form-control-error">'+window.msgs.duplicate_config+"</p>"),i=!1):void 0)}),i},complete:function(e){var t=e.responseJSON;if("success"==t.status)update_ipsec_auth(t),$("#auth-modal").modal("hide"),$("#conn-modal").is(":visible")&&($("#conn-modal .form-control-error").parent().removeClass("has-error").end().remove(),$("#authconfig").val($("#cfgname").val().trim()));else if("error"==t.status){if(t.message){for(name in t.message){var a=$('#auth-modal input[name="'+name+'"]:visible');a.parent().hasClass("input-group")&&(a=a.parent()),a.parent().addClass("has-error").append('<p class="form-control-error">'+t.message[name]+"</p>")}t.message.p12file&&$("#p12-group").addClass("has-error").append('<p class="form-control-error">'+t.message.p12file+"</p>"),t.message.cacertfile&&$("#cacert-group").addClass("has-error").append('<p class="form-control-error">'+t.message.cacertfile+"</p>"),t.message.clicertfile&&$("#clicert-group").addClass("has-error").append('<p class="form-control-error">'+t.message.clicertfile+"</p>"),t.message.clikeyfile&&$("#clikey-group").addClass("has-error").append('<p class="form-control-error">'+t.message.clikeyfile+"</p>")}}else"login"==t.status?location.reload(!0):($("#status-modal .modal-title").text(window.msgs.oops),$("#status-modal .modal-body p").text(t.message),$("#status-modal").modal("show"))}}),$('#ipsec-clients button[type="submit"]').on("click",function(e){e.preventDefault();var a={networks:[],configs:[],conns:[],splittunnel:{}};$("#ipsec-clients [name=network]").each(function(){$(this).prop("checked")&&a.networks.push($(this).val())}),$("#auth-configs tr:gt(0)").each(function(){if($(this).is(":last-child"))return!1;a.configs.push({name:$(this).data("oldname"),type:$(this).data("ipsec_type"),psk:$(this).data("psk"),cfguser:$(this).data("cfguser"),cfgpass:$(this).data("cfgpass")})}),$("#ipsec-conns tr:gt(0)").each(function(){if($(this).is(":last-child"))return!1;a.conns.push({name:$(this).data("oldconnname"),host:$(this).data("connhost"),authconfig:$(this).data("authconfig"),autostart:$(this).find("[name=autostart]").prop("checked")})}),a.splittunnel.mode=$("#ipsec-clients [name=splitmode]:checked").val(),a.splittunnel.domains=[],$.each($("#ipsec-clients [name=domains]").val().split(/\r?\n/),function(e,t){a.splittunnel.domains.push(t)});var t=$(this).parents("form");pcwrt.submit_form(t,JSON.stringify(a),function(e){$("#auth-configs").data("uncommitted",null),$("#ipsec-conns").data("uncommitted",null),pcwrt.apply_changes(e.apply)},"application/json")}),$('#ipsec-update button[type="submit"]').on("click",function(e){e.preventDefault();var t={extaddr:$("#extaddr").val(),ipaddr:$("#ipaddr").val(),netmask:$("#netmask").val(),users:[]};$("#users tr:gt(0)").each(function(){if($(this).is(":last-child"))return!1;t.users.push({type:$(this).data("type"),name:$("td:first",$(this)).text().trim(),password:$(this).data("password"),create:null==$(this).data("username"),guest:$("[name=guest]",$(this)).prop("checked"),vpnout:$("td:eq(1)",$(this)).text()==window.msgs.vpn})});var a=$(this).parents("form");pcwrt.submit_form(a,JSON.stringify(t),function(e){$("#users tr").each(function(){if($(this).is(":last-child"))return!1;$(this).data("username",$("td:first",$(this)).text().trim())}),$("#ipsec-status").text(msgs.enabled).parent().removeClass("alert-danger").addClass("alert-success"),$("#disable-ipsec").removeClass("hidden"),$("#restart-ipsec").removeClass("hidden"),$("#enable-ipsec").addClass("hidden"),$("#enable-disable").removeClass("hidden"),$("#enable-alert").addClass("hidden"),pcwrt.apply_changes(e.apply)},"application/json")}),$("#enable-ipsec").on("click",function(e){e.preventDefault(),$("#enable-disable").addClass("hidden"),$("#enable-alert").removeClass("hidden"),$("#ipsec-settings").slideDown()}),$("#disable-ipsec").on("click",function(e){var t;e.preventDefault(),disable_ipsec($(this).parents("form"))}),$("#restart-ipsec").on("click",function(e){e.preventDefault(),pcwrt.submit_form($("#restart-server"),{},function(e){pcwrt.show_message(msgs.restart_ipsec_title,msgs.restart_ipsec_message)})}),$("#ipsec-conns").on("click",".list-remove",function(e){e.preventDefault(),$("#ipsec-conns").data("deleteConfig",$(this).parents("tr").index()),pcwrt.confirm_action(window.msgs.delete_ipsec_conn_title,window.msgs.delete_ipsec_conn_confirm+' "'+$(this).parent().text().trim()+'"?',function(){var e=$("#ipsec-conns").data("deleteConfig"),t;$("#ipsec-conns tr:eq("+e+") td:first").text().trim()==$("#connect-ipsec [name=cfg]").val()&&$("#connect-ipsec [name=cfg]").val(""),$("#ipsec-conns tr:eq("+e+")").remove(),$("#ipsec-conns").data("uncommitted",!0)})}),$("#ipsec-conns").on("click",".list-edit",function(e){e.preventDefault();var t=$(this).parent().parent();$("#conn-modal").find(".modal-title").text(window.msgs.edit_ipsec_conn_title).end().find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end().find("input:not([type=radio],[type=checkbox])").val("").end().find("input[name=connname]").val($(this).parent().text().trim()).end().find("input[name=connhost]").val(t.data("connhost")).end().find("input[name=oldconnname]").val(t.data("oldconnname")).end().find("#authconfig").val(t.data("authconfig")).end().modal("show")}),$("#ipsec-conns").on("click","span.glyphicon.logs",function(e){e.preventDefault(),pcwrt.fetch_data($("#get-clientlog").attr("action"),{},function(e){$("#logs-modal").find("#client-logs").html(e).end().modal("show")})}),$("#ipsec-conns").on("click","span.glyphicon.control",function(e){if(e.preventDefault(),$("#auth-configs").data("uncommitted")||$("#ipsec-conns").data("uncommitted"))pcwrt.show_message(msgs.uncommitted_title,msgs.uncommitted_changes);else{var t=$(this);if(t.hasClass("glyphicon-play")){var a=$("#connect-ipsec");$("[name=action]",a).val("start"),$("[name=cfg]",a).val(t.parents("td:first").text().trim()),pcwrt.submit_form(a,a.serialize(),function(e){t.parents("td:first").removeClass("running connected stopped"),"running"!=e.state&&"connected"!=e.state&&"stopped"!=e.state||(t.parents("td:first").addClass(e.state).parent().siblings().find("td:first").removeClass("running connected stopped").find("span.logs").hide(),t.parents("tr:first").siblings().find("span.glyphicon.control").removeClass("glyphicon-stop").addClass("glyphicon-play"),t.removeClass("glyphicon-play").addClass("glyphicon-stop").attr("title","Stop").parents("td:first").find("span.logs").show())},null,!1,window.msgs.start_vpnconf+' "'+$("[name=cfg]",a).val()+'"')}else{var a=$("#connect-ipsec");$("[name=action]",a).val("stop"),$("[name=cfg]",a).val(t.parents("td:first").text().trim()),pcwrt.submit_form(a,a.serialize(),function(e){t.parents("td:first").removeClass("running connected").addClass("stopped"),t.removeClass("glyphicon-stop").addClass("glyphicon-play").attr("title","Start")},null,!1,window.msgs.stop_vpnconf+' "'+$("[name=cfg]",a).val()+'"')}}}),$(function(){var n=$("[name=network]:first").parent().parent();$.each(fv.client.enabled_network,function(e,t){if(0<e){var a=n.clone();n.after(a),n=a}var s=$("label",n).contents();s[s.length-1].nodeValue=t.text,$("input",n).prop("value",t.name),$("input",n).prop("checked",!!t.enabled)}),fv.client.configs&&(fv.client.configs.sort(function(e,t){return e.name.toUpperCase()>t.name.toUpperCase()?1:-1}),$.each(fv.client.configs,function(e,t){var a=$('<tr><td><span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span>'+t.name+"</td></tr>");a.data("oldname",t.name),a.data("ipsec_type",t.type),a.data("psk",t.psk),a.data("cfguser",t.username),a.data("cfgpass",t.password),a.data("cadn",t.cadn),a.data("clidn",t.clidn),$("#auth-configs tr:last").before(a)})),fv.client.conns&&(fv.client.conns.sort(function(e,t){return e.name.toUpperCase()>t.name.toUpperCase()?1:-1}),$.each(fv.client.conns,function(e,t){var a=$('<tr><td><span class="glyphicon glyphicon-play pull-right control" title="Start"></span><span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span><span class="glyphicon glyphicon-list-alt pull-right logs" title="View log" style="display:none"></span>'+t.name+'</td><td class="text-center"><input type="checkbox" name="autostart"></td></tr>');"1"==t.autostart&&a.find("[name=autostart]").prop("checked",!0),"connected"!=t.state&&"running"!=t.state&&"stopped"!=t.state||($("#connect-ipsec [name=cfg]").val(t.name),a.find("td:first").addClass(t.state).find("span.logs").show(),"stopped"!=t.state&&a.find(".glyphicon.control").removeClass("glyphicon-play").addClass("glyphicon-stop").attr("title","Stop")),a.data("oldconnname",t.name),a.data("connhost",t.host),a.data("authconfig",t.authconfig),$("#ipsec-conns tr:last").before(a)})),$("#ipsec-clients [name=splitmode]").each(function(){if(fv.client.splitmode==$(this).val())return $(this).prop("checked",!0),!1}),$("#ipsec-clients [name=domains]").val(fv.client.domains.sort(function(e,t){return e.toUpperCase()>t.toUpperCase()?1:-1}).join("\r\n")),pcwrt.populate_forms(fv.server),fv.server.users.sort(function(e,t){return e.name.toUpperCase()>t.name.toUpperCase()?1:-1}),$.each(fv.server.users,function(e,t){var a='<tr><td><span class="pull-right list-remove" title="Delete user">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span>';"ikev2"==t.type&&(a+='<span class="pull-right glyphicon glyphicon-download-alt control" title="Download user certificate"></span>'),a+=t.name+"</td><td>"+(t.vpnout?window.msgs.vpn:window.msgs.isp)+'</td><td class="text-center"><input type="checkbox" name="guest"'+(t.guest?" checked":"")+"></td></tr>",a=$(a),$("#users tr:last").before(a),a.data("username",t.name),a.data("type",t.type),"ikev1"==t.type&&a.data("password",t.password)}),"0"==fv.server.enabled?($("#enable-disable").addClass("alert-danger").removeClass("alert-success"),$("#ipsec-status").text(window.msgs.disabled),$("#enable-ipsec").removeClass("hidden")):($("#enable-disable").removeClass("alert-danger").addClass("alert-success"),$("#ipsec-status").text(window.msgs.enabled),$("#disable-ipsec").removeClass("hidden"),$("#restart-ipsec").removeClass("hidden"),$("#ipsec-settings").slideDown()),$("#authconfig").makecombo(),update_auth_config_select(),window.setInterval(function(){var e=$("#connect-ipsec"),t=$("[name=cfg]",e).val();pcwrt.is_empty(t)||pcwrt.fetch_data(e.data("state_url"),{cfg:t},function(e){var t=null;$("#ipsec-conns tr:gt(0)").find("td:first").removeClass("running connected stopped").each(function(){$(this).find("span.logs").hide(),$(this).text().trim()==e.cfg&&(t=$(this))}),t&&t.addClass(e.state).find("span.logs").show()})},1e4)});