var calendar_colors=["#777777","#d9534f","#5cb85c","#5bc0de","#cd7416","#f691b2","#428bca","#9a9cff"];function findDnsProvider(s){var r="custom";return $.each(fv.dns_options,function(e,a){var t=!1;if($.each(a,function(e,a){if(a.ips&&a.ips.length==s.length){t=!0;for(var e=0;e<a.ips.length;e++)if(a.ips[e]!=s[e]){t=!1;break}if(t)return r=a.key,!1}}),t)return!1}),r}function getDNSProviderByName(t){var s=!1;return $.each(fv.dns_options,function(e,a){if($.each(a,function(e,a){if(a.key==t)return s=a,!1}),s)return!1}),s}function refreshDNSSelectionList(t){var e=["default","opendns","cleanbrowsing","cloudflare","adguard","yandex","google","custom"];$("[name=dns-select]",t).empty(),$.each(e,function(e,a){0<e&&$("[name=dns-select]",t).append('<optgroup label="'+a+'"></optgroup>'),$.each(fv.dns_options[a],function(e,a){$("[name=dns-select]",t).append('<option value="'+a.key+'">'+a.name+"</option>")})}),fv.enable_opendns_home||$('option[value="opendns_b"]').prop("disabled",!0)}function syncDNSSelection(e,a){var t=findDnsProvider(a),s=$("input[name=dns-select]",e);s.val("custom").val(t),"custom"==s.val()?($("input[name=dns1]",e).unbind("change").change(function(){$(this).val($(this).val().trim())}).show().prop("readonly",!1).val(a[0]).next().unbind("change").change(function(){$(this).val($(this).val().trim())}).show().prop("readonly",!1),1<a.length&&$("input[name=dns2]",e).val(a[1])):s.trigger("selection.change",[0,t,""])}function refreshProfileSelect(){var t=[];$.each(fv.profiles,function(e,a){t.push({value:e,text:a.name})}),$("#profile").updatecombo(t)}function assignUserProfile(t,e,s){var r=0;e?r=e.data("profile"):$.each(fv.vpn_users,function(e,a){if(a.name==t)return r=a.p1,!1}),s!=r&&(r&&0<r&&$("#profiles .panel:eq("+r+") .user-list li").each(function(){$(this).text().trim()==t&&$(this).remove()}),s&&0<s&&$("#profiles .panel:eq("+s+") .user-list").append('<li class="option-list"><span class="list-remove pull-right">&nbsp;</span>'+t+"</li>"),e?($("td:eq(1)",e).html('<span class="pull-right list-remove">&nbsp;</span><span class="pull-right list-edit">&nbsp;</span>'+fv.profiles[s].name),e.data("profile",s)):$.each(fv.vpn_users,function(e,a){if(a.name==t)return a.profile=s,a.p1=s,!1}))}function assignDeviceProfile(e,a){var t=e.profile;t!=a&&(t&&0<t&&$("#profiles .panel:eq("+t+") .device-list li").each(function(){$(this).text().trim()==e.name&&$(this).remove()}),a&&0<a&&$("#profiles .panel:eq("+a+") .device-list").append('<li class="option-list"><span class="list-remove pull-right">&nbsp;</span>'+e.name+"</li>"),e.profile=a)}function create_overlay(e,a){var t=$("tr:eq(1) td:eq("+a+")",e),s=$("tr:last td:last",e);$c=$("<div/>",{class:"ts-container"}).css({position:"absolute",top:t.position().top+e.position().top+parseInt(e.css("margin-top"))+1,left:t.position().left+e.position().left+1,width:t.width(),height:"1440px","background-color":"transparent","z-index":0}).data("day",a-1),e.after($c)}function refreshCalendarList(e,a){var t=$("#profiles .panel:eq("+e+")");$(".calendar-list",t).empty(),a&&$.each(a,function(e,a){a.color=calendar_colors[e%calendar_colors.length],$calbtn=$('<div class="btn btn-sm btn-calendar" style="background-color:'+a.color+'">'+a.name+"&nbsp;<div>&cross;</div></div>"),$calbtn.data("id",a.id),$calbtn.data("pausable",a.pausable),$(".calendar-list",t).append($calbtn)}),$(".calendar-list",t).append('<button class="btn btn-sm btn-default edit-calendar">'+window.msgs.view_edit_calendars+"</button>")}function refreshEditCalendarList(){$("#edit-calendar-list").empty(),$(".ts-container").remove();for(var p=$("#calendar-dialog").data("calendars"),e=0;e<p.length;e++)$("#edit-calendar-list").append('<div class="btn btn-sm btn-calendar" style="background-color:'+calendar_colors[e%calendar_colors.length]+'">'+p[e].name+"&nbsp;<div>&cross;</div></div>&nbsp;");$("#edit-calendar-list").append('<button class="btn btn-sm btn-default">'+window.msgs.new_calendar+"</button>");for(var a=$("#graphic-calendar"),e=1;e<=7;e++)create_overlay(a,e);var c=Math.floor(100/p.length);$.each(p,function(i,o){var d=i*c;$(".ts-container").each(function(){var l=$(this),e=l.data("day");o.times[e]&&o.times[e].replace(/(\d?\d:\d?\d ?(?:am|pm)) ?- ?(\d?\d:\d?\d ?(?:am|pm))/g,function(e,a,t){var s=pcwrt.time2pixel(a),r=pcwrt.time2pixel(t);0==r&&(r=$(".ts-container").height());var n=$('<div class="slider"></div>');n.data("calendar",i).css({top:s,left:d+"%",width:c+"%","margin-left":"1px","background-color":o.color}).outerHeight(r-s),i==p.length-1&&n.css("margin-right","1px"),l.append(n)})})}),$(".ts-container .slider").css("cursor","pointer").on("click",function(){editCalendar($(this).data("calendar"))})}function editCalendar(e){$("#edit-calendar-list").hide(),$("#calendar-dialog .form-group").removeClass("has-error").find("p").remove();var a=$("#calendar-dialog").data("calendars")[e];a?$("#calendar-dialog .modal-header h4").text(window.msgs.edit_calendar):(a={name:"",color:calendar_colors[e%calendar_colors.length],domains:[],times:[]},$("#calendar-dialog .modal-header h4").text(window.msgs.new_calendar)),$("#edit-calendar-form").data("cal-idx",e).show(),$("#calendar-name").val(a.name),$("#calendar-color-picker").css("background-color",a.color),$("#calendar-color").val(a.color),$("#calendar-domains").val(a.domains.join("\n")),$("#text-calendar textarea").val(""),$.each(a.times,function(e,a){$("#text-calendar tr:eq(1) td:eq("+e+") textarea").val(a)}),$("#calendar-tabs").show(),$("#calendar-tabs a:first").trigger("shown.bs.tab"),$("#calendar-dialog").scrollTop(28).find("button.btn-default").show(),$("#calendar-dialog .modal-backdrop").height($("#calendar-dialog .modal-dialog").height()+50)}function proxyEnabled(){return $('input[name="proxy"]').prop("checked")}function canAddUser2Profile(){return proxyEnabled()||0<fv.vpn_users.length}function toggleAddUser2Profile(){canAddUser2Profile()?$("#profiles .profile-users").each(function(){$(this).children("div:eq(1)").show()}):$("#profiles .profile-users").each(function(){$(this).children("div:eq(1)").hide()})}function isLockPC(e){return $("[name=block_literal_ip]",e).prop("checked")||$("[name=block_proxy]",e).prop("checked")||$("[name=block_proxy2]",e).prop("checked")||0<$(".btn-calendar",e).length}function updateEnablePcState(e){isLockPC(e)&&$("[name=enable_pc]",e).prop("checked",!0)}function toggleAuthProxySettings(){proxyEnabled()?($("#proxy-port-div").slideDown(),$("#proxy-users").slideDown()):($("#proxy-port-div").slideUp(),$("#proxy-users").slideUp()),toggleAddUser2Profile()}function toggleProfileParentalControl(e,a){var t=e.parents(".panel:first");if(a&&!e.prop("checked")&&isLockPC(t))return pcwrt.show_message(window.msgs.enforce_access_control_title,window.msgs.enforce_access_control_msg),void e.prop("checked",!0);if(e.prop("checked"))$(".panel-collapse",t).hasClass("in")&&t.data("pausable")&&t.find(".profile.pause").data("click",0).removeClass("disabled");else if(t.find(".profile.pause").addClass("disabled"),$(".panel-heading",t).removeClass("warning"),$(".profile-pause-alert",t).slideUp(),t.data("pausable")){var s=[{name:"pause",value:"-1"},{name:"profile",value:fv.profiles[t.index()].id}];$.each(fv.profiles[t.index()].calendars,function(e,a){"number"==typeof a.id&&a.pausable&&(s.push({name:"calendar",value:a.id}),a.pausable=!1)}),request_pause($("#pause").data("url"),s)}}function addProfile(e){var a=$("#profiles .panel").length,t=$("#profiles .panel:first").clone();return $(".panel-heading",t).prepend('<span class="pull-right list-remove">&nbsp;</span><span class="pull-right list-edit">&nbsp;</span>'),$("a:first",t).attr("href","#p"+a).text(e),$("#p0",t).attr("id","p"+a).removeClass("in"),$(".profile-users",t).removeClass("hidden").find(".device-list").empty().end().find(".user-list").empty(),$(".calendar-list",t).empty().append('<button class="btn btn-sm btn-default edit-calendar">'+window.msgs.view_edit_calendars+"</button>"),$("[name=yt_restricted]",t).attr("name","p"+a+"_yt_restricted"),$("[name=url_block_mode]",t).attr("name","p"+a+"_url_block_mode"),$("#profiles").append(t),t.find(".combo-group").remove(),$("[name=dns-select]",t).makecombo(),$("input[name=dns-select]",t).val("default").trigger("selection.change",[0,"default",""]),$("table.qos input",t).each(function(){var e=$(this),a;e.parent().after(e),e.prev().remove(),e.makeunit()}),$(".profile-pause-alert",t).find("span:first").text("").end().hide(),$(".profile.pause",t).addClass("disabled").data("click",0),$(".calendar.pause",t).addClass("disabled"),t}function validateForm(){var s=!0,r=null;return $(".form-control.has-error").removeClass("has-error"),$("form:first p.form-control-error").parent().removeClass("has-error").end().remove(),$("[name=proxy]").prop("checked")&&(pcwrt.is_valid_port($("[name=proxy-port]").val())||($("[name=proxy-port]").after('<p class="form-control-error">'+window.msgs.invalid_port_number+".</p>").parent().addClass("has-error"),r=$("[name=proxy-port]"),s=!1)),$("#profiles .panel").each(function(){var e=$(this),a=getDNSProviderByName($(".combo-facade[name=dns-select]",e).val());if(a&&"custom"!=a.key)return!0;pcwrt.is_valid_ipaddr($("[name=dns1]",e).val())||($("[name=dns1]",e).addClass("has-error"),r=r||$("[name=dns1]"),s=!1);var t=$("[name=dns2]",e).val();return pcwrt.is_empty(t)||pcwrt.is_valid_ipaddr(t)||($("[name=dns2]",e).addClass("has-error"),r=r||$("[name=dns2]"),s=!1),$("[name=dns1]",e).hasClass("has-error")||$("[name=dns2]",e).hasClass("has-error")?($("[name=dns2]",e).after('<p class="form-control-error has-error">'+window.msgs.invalid_dns_ip+".</p>"),$(".panel-collapse",e).hasClass("in")||$(".panel-title a",e).trigger("click"),!1):void 0}),r&&r.trigger("focus"),s}function refreshPauseLabels(e){var t=!0;if($.each(fv.profiles[e].calendars,function(e,a){if("paused"==a.status)return t=!1}),t){var a=$("#profiles .panel:eq("+e+")");$(".calendar.control-label",a).removeClass("paused"),$(".profile-pause-alert",a).is(":visible")||$(".panel-heading",a).removeClass("warning")}}$("#enable-pc").on("click",function(e){e.preventDefault(),$("#enable-disable").addClass("hidden"),$("#enable-alert").removeClass("hidden"),$("#pc-settings").slideDown()}),$("#disable-pc").on("click",function(e){e.preventDefault();var a=$(this).parents("form");pcwrt.submit_form(a,JSON.stringify({disabled:"1"}),function(e){$("#pc-status").text(msgs.disabled).parent().removeClass("alert-success").addClass("alert-danger"),$("#enable-pc").removeClass("hidden"),$("#disable-pc").addClass("hidden"),$("#pc-settings").slideUp(),$("#profiles .panel").data("pausable",!1),$("#profiles .panel .profile.pause").addClass("disabled"),$("#profiles .panel .calendar.pause").addClass("disabled"),$("#profiles .panel .btn-calendar").data("pausable",!1),$(".settings-header h3 a").hide(),pcwrt.apply_changes(e.apply)})}),$(function(){$('input[name="proxy"]').on("click",function(){toggleAuthProxySettings()});for(var e=["12 <sup>am</sup>","1 <sup>am</sup>","2 <sup>am</sup>","3 <sup>am</sup>","4 <sup>am</sup>","5 <sup>am</sup>","6 <sup>am</sup>","7 <sup>am</sup>","8 <sup>am</sup>","9 <sup>am</sup>","10 <sup>am</sup>","11 <sup>am</sup>","12 <sup>pm</sup>","1 <sup>pm</sup>","2 <sup>pm</sup>","3 <sup>pm</sup>","4 <sup>pm</sup>","5 <sup>pm</sup>","6 <sup>pm</sup>","7 <sup>pm</sup>","8 <sup>pm</sup>","9 <sup>pm</sup>","10 <sup>pm</sup>","11 <sup>pm</sup>"],a=$("#graphic-calendar"),t=0;t<e.length;t++)$('<tr><td rowspan="2">'+e[t]+"</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>").appendTo(a),$('<tr class="odd"><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>').appendTo(a);function r(t,s,r){$.each(fv.profiles,function(e,a){$.each(a.calendars,function(e,a){if("number"==typeof a.id&&a.id==t)return a.status=s,void(a.message=r)})})}$("tr:first td:first",a).css({"border-top":"1px solid transparent","border-left":"1px solid transparent"}),$("td",a).outerHeight(30),$("tr:first td",a).outerHeight(51),$("tr:last td",a).outerHeight(31),$("#text-calendar tr:first td").outerHeight(51),$("#calendar-tabs a:first").tab("show"),$("#calendar-tabs").hide(),$("#edit-calendar-form").hide(),$("#edit-calendar-list").on("click",".btn-calendar,button.btn",function(e){e.preventDefault(),editCalendar($(this).index())}),$("#calendar-dialog button").on("click",function(){if($("#edit-calendar-list").is(":visible")){var e=$("#calendar-dialog").data("profile"),a=$("#calendar-dialog").data("calendars");refreshCalendarList(e,fv.profiles[e].calendars=a),$("#calendar-dialog").modal("hide"),refreshPauseLabels(e),updateEnablePcState($("#profiles .panel:eq("+e+")"))}else{if($(this).hasClass("save")){if($("#calendar-dialog .form-group").removeClass("has-error").find("p").remove(),/^\s*$/.test($("#calendar-name").val()))return $("#calendar-name").after('<p class="form-control-error">'+window.msgs.enter_calendar_name+"</p>").parents(".form-group:first").addClass("has-error"),void $("#calendar-dialog").scrollTop(28);$("#calendar-graphic-input").is(":visible")&&$('#calendar-tabs [href="#calendar-text-input"]').trigger("show.bs.tab");var t=$("#edit-calendar-form").data("cal-idx"),s=$("#calendar-dialog").data("calendars")[t];s||(s={name:"",color:"#cccccc",domains:[],times:[]},$("#calendar-dialog").data("calendars")[t]=s),s.name=$("#calendar-name").val(),s.color=$("#calendar-color").val();var r=$.trim($("#calendar-domains").val());s.domains=r?r.split(/\r?\n/):[],$("#text-calendar tr:eq(1) textarea").each(function(){s.times[$(this).parent().index()]=$(this).val()})}0<$("#calendar-dialog").data("calendars").length?($(".modal-header h4",$(this).parents(".modal-dialog")).text(window.msgs.calendars),$("#edit-calendar-list").show(),$("#calendar-tabs a:first").tab("show"),$("#calendar-tabs").hide(),$("#edit-calendar-form").hide(),$("#calendar-dialog").scrollTop(28).find("button.btn-default").hide(),refreshEditCalendarList(),$("#calendar-dialog .modal-backdrop").height($("#calendar-dialog .modal-dialog").height()+50)):$("#calendar-dialog").modal("hide")}}),$(window).on("resize",function(){$(".ts-container").each(function(){var e=$(this),a=e.data("day")+1,t=e.prevAll("table:first"),s=$("tr:eq(1) td:eq("+a+")",t),r=$("tr:last td:last",t);e.css({left:s.position().left+t.position().left+1,width:s.width(),height:r.position().top-s.position().top+r.height()})})}),$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){var a;if("#calendar-graphic-input"==e.target.hash){$(".ts-container").remove();var t=$("#graphic-calendar");if(!t.is(":visible"))return;for(var s=1;s<=7;s++)create_overlay(t,s);var r=[];$("#text-calendar tr:eq(1) textarea").each(function(){var n=[];$(this).val().replace(/(\d?\d:\d?\d ?(?:am|pm)) ?- ?(\d?\d:\d?\d ?(?:am|pm))/g,function(e,a,t){var s=pcwrt.time2pixel(a),r=pcwrt.time2pixel(t);return 0==r&&(r=$(".ts-container").height()),n.push([s,r]),e}),r.push(n)}),$(".ts-container").sort(function(e,a){return $(e).data("day")-$(a).data("day")}).addRangeSelect($("#calendar-color-picker").css("background-color"),function(e){return pcwrt.pixel2time(e,$(".ts-container").height())},r)}}),$('a[data-toggle="tab"]').on("show.bs.tab",function(e){var a;"#calendar-text-input"==e.target.hash&&$(".ts-container").each(function(){var r="";$(".slider",$(this)).sort(function(e,a){return $(e).position().top-$(a).position().top}).each(function(){var e=$(this).position().top+10,a=pcwrt.pixel2time(e);a.length<8&&(a="0"+a);var t=pcwrt.pixel2time(e+$(".spacer",$(this)).height());t.length<8&&(t="0"+t);var s=a+" - "+t;r=r?r+"\n"+s:s}),$("#text-calendar tr:eq(1) td:eq("+$(this).data("day")+") textarea").val(r)})}),$("#profiles").on("click","[name=enable_pc]",function(e){toggleProfileParentalControl($(this),!0)}),$("#profiles").on("click","[name=block_literal_ip],[name=block_proxy],[name=block_proxy2]",function(e){updateEnablePcState($(this).parents(".panel"))}),$("#profiles").on("click",".edit-calendar",function(e){e.preventDefault();var a=$(this).parents(".panel:first").index(),t=JSON.parse(JSON.stringify(fv.profiles[a].calendars));$("#calendar-dialog").data("calendars",t).data("profile",a).modal({keyboard:!1,backdrop:"static"}).modal("show"),$("#calendar-dialog .modal-backdrop").height($("#calendar-dialog .modal-dialog").height()+50),0<fv.profiles[a].calendars.length?($("#calendar-dialog .modal-header h4").text(window.msgs.calendars),$("#edit-calendar-list").show(),$("#calendar-tabs a:first").tab("show"),$("#calendar-tabs").hide(),$("#edit-calendar-form").hide(),$("#calendar-dialog").find("button.btn-default").hide(),refreshEditCalendarList()):editCalendar(0)}),$("#profiles").on("click",".btn-calendar",function(e){if(e.preventDefault(),e.stopPropagation(),!(0<$(this).parents(".popover").length)){var a=$(this).parents(".panel:first").index();$("#calendar-dialog").data("calendars",JSON.parse(JSON.stringify(fv.profiles[a].calendars))).data("profile",a).modal({keyboard:!1,backdrop:"static"}).modal("show"),editCalendar($(this).index())}}),$("#add-profile").on("click",function(e){e.preventDefault(),$("#add-profile-dialog .form-group").removeClass("has-error").find("p").remove(),$("#add-profile-dialog").modal("show"),$("#profilename").val("").trigger("focus")}),$("#add-profile-dialog .btn-success").on("click",function(){if($("#add-profile-dialog .form-group").removeClass("has-error").find("p").remove(),/^[a-zA-Z0-9._ -]+$/.test($("#profilename").val())){var e=addProfile($("#profilename").val());fv.profiles.push({name:$("#profilename").val(),calendars:[]}),$("#add-profile-dialog").modal("hide"),$(".panel-title a",e).trigger("click"),refreshProfileSelect()}else $("#profilename").after('<p class="form-control-error">'+window.msgs.enter_profile_name+"</p>").parent().addClass("has-error")}),$("#profiles").on("click",".panel-heading .list-remove",function(e){e.preventDefault(),$("#profiles").data("deleteProfile",$(this).parents(".panel").index()),pcwrt.confirm_action(window.msgs.delete_profile_title,window.msgs.delete_profile_confirm+' "'+$(this).parent().find("h4 a").text()+'"?',function(){var t=$("#profiles").data("deleteProfile"),e=$("#profiles .panel:eq("+t+")");if(e.data("pausable")){var s=[{name:"pause",value:"-1"},{name:"profile",value:fv.profiles[t].id}];$.each(fv.profiles[t].calendars,function(e,a){"number"==typeof a.id&&a.pausable&&(s.push({name:"calendar",value:a.id}),a.pausable=!1)}),request_pause($("#pause").data("url"),s)}e.remove(),fv.profiles.splice(t,1),$.each(fv.devices,function(e,a){a.profile==t&&(fv.devices[e].profile=0)}),$("#users tr:gt(0)").each(function(){$(this).data("profile")==t&&($(this).data("profile","0"),$("td:eq(1)",$(this)).html(fv.profiles[0].name+'<span class="pull-right list-remove">&nbsp;</span><span class="pull-right list-edit">&nbsp;</span></td></tr>'))}),$("#profiles .panel").each(function(e){$("a",$(this)).attr("href","#p"+e);var a=$(".panel-collapse",$(this)),t=a.attr("id");a.attr("id","p"+e),$("#users tr:gt(0)").each(function(){"p"+$(this).data("profile")==t&&$(this).data("profile",a.attr("id").substr(1))})}),refreshProfileSelect()})}),$("#profiles").on("click",".panel-heading .list-edit",function(e){e.preventDefault(),$("#edit-profile-dialog .form-group").removeClass("has-error").find("p").remove();var a=$(this).parents(".panel").index();$("#edit-profile-dialog").data("editProfile",a).modal("show"),$("#profilename2").val(fv.profiles[a].name).trigger("focus")}),$("#profiles").on("click",".profile.pause",function(e){if(e.preventDefault(),!$(this).hasClass("disabled")){var a=$(this).parents(".panel").index(),t=$(this),s=t.data("click");if(1==++s){var r=setTimeout(function(){request_pause($("#pause").data("url"),[{name:"pause",value:"1"},{name:"profile",value:fv.profiles[a].id}]),t.data("click",0)},300);t.data("click",s),t.data("timer",r)}else clearTimeout(t.data("timer")),t.data("click",0),request_pause($("#pause").data("url"),[{name:"pause",value:"2"},{name:"profile",value:fv.profiles[a].id}])}}).on("dblclick",".profile.pause",function(e){e.preventDefault()}),$("#profiles").on("click",".calendar.pause",function(e){if(e.preventDefault(),!$(this).hasClass("disabled")){var i="<p>Click the + or - next to the calendar name to add/subtract time extensions.</p>";$(this).parent().siblings(".calendar-list").find(".btn-calendar").each(function(e,t){if($(t).data("pausable")&&$(t).data("id")){var a=$(t).contents().filter(function(){return 3==this.nodeType}).text(),s=$('<div class="btn btn-sm btn-calendar"></div>');s.text(a),s.css("background-color",$(t).css("background-color")),i+='<div class="form-group">'+s.prop("outerHTML")+'<div class="btn-group pull-right" style="display:inline-block" role="group" data-id="'+$(t).data("id")+'"><div class="btn btn-default btn-sm cpause list-remove">&nbsp;</div><div class="btn btn-default btn-sm cpause list-add">&nbsp;</div></div></div>';var r=window.msgs.calendar_active,n=$(this).parents(".panel:first").index(),l="";$.each(window.fv.profiles[n].calendars,function(e,a){if(a.id==$(t).data("id"))return"paused"==a.status&&(l="paused",r=a.message),!1}),i+='<p class="cal-pause-msg '+l+'">'+r+"</p>"}});var a=$('<div class="modal-backdrop in"></div>');a.height($(window).height()),$(this).append(a),$(window).on("resize",t),$(this).on("click","div.modal-backdrop",function(e){e.preventDefault(),e.stopPropagation(),$(window).off("resize",t),$(this).parent().popover("destroy"),$(this).remove()}),$(this).popover({content:i,html:!0,trigger:"manual"}).popover("show")}function t(){a.height($(window).height())}}),$("#profiles").on("click",".cpause",function(e){e.preventDefault();var a=$(this).hasClass("list-add")?900:-900,t=$(this).parent().data("id"),s=$(this);request_pause($("#pause").data("url"),[{name:"pause",value:"1"},{name:"calendar",value:t},{name:"delta",value:a}],function(e){"paused"==e.status?s.parents(".form-group:first").next().text(e.message).addClass("paused"):s.parents(".form-group:first").next().text(window.msgs.calendar_active).removeClass("paused"),r(t,e.status,e.message),0<s.parents(".popover-content:first").find(".cal-pause-msg.paused").length?(s.parents(".control-label").addClass("paused"),s.parents(".panel").find(".panel-heading").addClass("warning")):(s.parents(".control-label").removeClass("paused"),s.parents(".panel").find(".profile-pause-alert").is(":visible")||s.parents(".panel").find(".panel-heading").removeClass("warning"))})}),$("#profiles").on("click",".resume",function(e){e.preventDefault();var a=$(this).parents(".panel").index();request_pause($("#pause").data("url"),[{name:"pause",value:"0"},{name:"profile",value:fv.profiles[a].id}])}),$("#edit-profile-dialog .btn-success").on("click",function(){if($("#edit-profile-dialog .form-group").removeClass("has-error").find("p").remove(),/^\s*$/.test($("#profilename2").val()))$("#profilename2").after('<p class="form-control-error">'+window.msgs.enter_profile_name+"</p>").parent().addClass("has-error");else{var e=$("#edit-profile-dialog").data("editProfile"),a=$("#profiles .panel:eq("+e+")");$(".panel-title a",a).text($("#profilename2").val()),fv.profiles[e].name=$("#profilename2").val(),$("#edit-profile-dialog").modal("hide"),$("#users tr:gt(0)").each(function(){$(this).data("profile")==e&&$("td:eq(1)",$(this)).html($("#profilename2").val()+'<span class="pull-right list-remove">&nbsp;</span><span class="pull-right list-edit">&nbsp;</span></td></tr>')}),refreshProfileSelect()}}),$("#profiles,#edit-calendar-list").on("click",".btn-calendar div",function(e){e.preventDefault(),e.stopPropagation();var a=0<$(this).parents("#profiles").length,t=a?$(this).parents(".panel:first").index():$("#calendar-dialog").data("profile"),s=$(this).parent().index();pcwrt.confirm_action(window.msgs.delete_calendar_title,window.msgs.delete_calendar_confirm+' "'+fv.profiles[t].calendars[s].name+'"?',function(){var e=fv.profiles[t].calendars[s];"number"==typeof e.id&&e.pausable&&request_pause($("#pause").data("url"),[{name:"pause",value:"-1"},{name:"calendar",value:e.id}]),a?(fv.profiles[t].calendars.splice(s,1),refreshCalendarList(t,fv.profiles[t].calendars),refreshPauseLabels(t)):($("#calendar-dialog").data("calendars").splice(s,1),refreshEditCalendarList()),updateEnablePcState($("#profiles .panel:eq("+t+")"))})}),$("#chg-msg").on("click",function(e){e.preventDefault(),$("#chgmsg-dialog [name=url_blocked]").val($("#msg-url-blocked").text()),$("#chgmsg-dialog [name=site_closed]").val($("#msg-site-closed").text()),$("#chgmsg-dialog").modal("show")}),$("#chgmsg-dialog .btn-success").on("click",function(e){e.preventDefault(),$("#msg-url-blocked").text($("#chgmsg-dialog [name=url_blocked]").val()),$("#msg-site-closed").text($("#chgmsg-dialog [name=site_closed]").val()),$("#chgmsg-dialog").modal("hide")}),$("#add-user").on("click",function(e){e.preventDefault(),$("#user-dialog .form-group").removeClass("has-error").find("p").remove(),$("#user-dialog").modal("show"),$("#username").val("").data("rowname",null).trigger("focus"),$("#password").val(""),$("#profile").val("0")}),$("#user-dialog .btn-success").on("click",function(e){if(e.preventDefault(),$("#user-dialog .form-group").removeClass("has-error").find("p").remove(),/^[a-zA-Z0-9._ -]+$/.test($("#username").val())){var a=null,t=null;if($("#users tr:gt(0)").each(function(){$(this).is(":last-child")||($(this).data("username")==$("#username").data("rowname")&&(a=$(this)),$(this).data("username")==$("#username").val()&&$(this).data("username")!=$("#username").data("rowname")&&(t="duplicate"))}),"duplicate"!=t){if(a)$("td:eq(0)",a).text($("#username").val());else{if(/^\s*$/.test($("#password").val()))return void $("#password").after('<p class="form-control-error">'+window.msgs.enter_password+"</p>").parent().addClass("has-error");a=$("<tr><td>"+$("#username").val()+"</td><td></td></tr>"),$("#users tr:last").before(a)}a.data("username",$("#username").val().trim()),/^\**$/.test($("#password").val())||a.data("password",$("#password").val()),assignUserProfile($("#username").val(),a,$("#profile").val()),$("#user-dialog").modal("hide")}else $("#username").after('<p class="form-control-error">'+window.msgs.user_name_exists+"</p>").parent().addClass("has-error")}else $("#username").after('<p class="form-control-error">'+window.msgs.enter_valid_user_name+"</p>").parent().addClass("has-error")}),$("#users").on("click",".list-remove",function(e){e.preventDefault(),$("#users").data("deleteUser",$(this).parents("tr").index()),pcwrt.confirm_action(window.msgs.delete_user_title,window.msgs.delete_user_confirm+' "'+$(this).parent().prev().text()+'"?',function(){var e=$("#users").data("deleteUser");$("#users tr:eq("+e+")").remove()})}),$("#users").on("click",".list-edit",function(e){e.preventDefault();var a=$(this).parent().prev().text().trim();$("#user-dialog .form-group").removeClass("has-error").find("p").remove(),$("#username").val(a).data("rowname",a),$("#password").val("*******************"),$("#profile").val($(this).parents("tr").data("profile")),$("#user-dialog").modal("show")}),$("#profiles").on("click",".add-profile-user",function(e){e.preventDefault();var t=$(this).parents(".panel").index(),s=[],r={};$("#users tr:gt(0)").each(function(){if(!$(this).is(":last-child")&&$(this).data("profile")!=t){var e=$("td:first",$(this)).text().trim();r[e]||(s.push(e),r[e]=1)}}),$.each(fv.vpn_users,function(e,a){a.profile==t||r[a.name]||(s.push(a.name),r[a.name]=1)}),$("#add-user-dialog .list-group").empty(),0==s.length?($("#add-user-dialog .empty").show(),$("#add-user-dialog .not-empty").hide()):(s.sort(function(e,a){return e.toUpperCase()>a.toUpperCase()?1:-1}),$.each(s,function(e,a){$("#add-user-dialog .list-group").append('<li class="list-group-item clickable">'+a+"</li>")}),$("#add-user-dialog .empty").hide(),$("#add-user-dialog .not-empty").show()),$("#add-user-dialog").data("profile",t).modal("show")}),$("#add-user-dialog").on("click",".list-group-item",function(){var e=null,a=$(this).text().trim();$("#users tr:gt(0)").each(function(){$(this).data("username")==a&&(e=$(this))});var t=$("#add-user-dialog").data("profile");assignUserProfile(a,e,t),$("#add-user-dialog").modal("hide")}),$("#profiles").on("click",".panel:gt(0) .user-list .list-remove",function(e){e.preventDefault();var a=null,t=$(this).parent().text().trim();$("#users tr:gt(0)").each(function(){$(this).data("username")==t&&(a=$(this))}),assignUserProfile(t,a,0)}),$("#profiles").on("click",".add-profile-device",function(e){e.preventDefault();var t=$(this).parents(".panel").index(),s=[];$.each(fv.devices,function(e,a){a.profile!=t&&s.push(a)}),$("#add-device-dialog .list-group").empty(),0==s.length?($("#add-device-dialog .empty").show(),$("#add-device-dialog .not-empty").hide()):($.each(s,function(e,a){$("#add-device-dialog .list-group").append('<li class="list-group-item clickable">'+a.name+"</li>")}),$("#add-device-dialog .empty").hide(),$("#add-device-dialog .not-empty").show()),$("#add-device-dialog").data("profile",t).modal("show")}),$("#add-device-dialog").on("click",".list-group-item",function(){var t=null,s=$(this).text();if($.each(fv.devices,function(e,a){a.name==s&&(t=a)}),t){var e=$("#add-device-dialog").data("profile");assignDeviceProfile(t,e)}$("#add-device-dialog").modal("hide")}),$("#profiles").on("click",".panel:gt(0) .device-list .list-remove",function(e){e.preventDefault();var t=null,s=$(this).parent().text().trim();$.each(fv.devices,function(e,a){a.name==s&&(t=a)}),t&&assignDeviceProfile(t,0)}),$("#profiles").on("selection.change",".combo-facade[name=dns-select]",function(e,a,t,s){var r=getDNSProviderByName(t),n=$(this).parent().next().next();r&&"custom"!=r.key?0==r.ips.length?n.val("").hide().next().val("").hide():(n.show().next().show(),n.val(r.ips[0]).next().val(r.ips[1]),n.prop("readonly",!0).next().prop("readonly",!0)):(n.unbind("change").change(function(){$(this).val($(this).val().trim())}).show().next().unbind().change(function(){$(this).val($(this).val().trim())}).show(),n.val("").prop("readonly",!1).next().val("").prop("readonly",!1)),n.removeClass("has-error").next().removeClass("has-error").next("p").remove()}),refreshDNSSelectionList($("#p0")),"1"==fv.disabled?($("#enable-disable").addClass("alert-danger").removeClass("alert-success"),$("#pc-status").text(window.msgs.disabled),$("#enable-pc").removeClass("hidden")):($("#enable-disable").removeClass("alert-danger").addClass("alert-success"),$("#pc-status").text(window.msgs.enabled),$("#disable-pc").removeClass("hidden"),$("#pc-settings").slideDown()),fv.url_blocked&&!/^\s*$/.test(fv.url_blocked)&&$("#msg-url-blocked").text(fv.url_blocked),fv.site_closed&&!/^\s*$/.test(fv.site_closed)&&$("#msg-site-closed").text(fv.site_closed),$("#cbtoken").val(fv.cbtoken),$("label.required").add_required_mark(window.msgs.required),$("label.control-label[data-hint]").init_hint(),$("#profile").makecombo(),$("input[name=proxy]").prop("checked",fv.auth_proxy),0<fv.auth_proxy_port&&$("input[name=proxy-port]").val(fv.auth_proxy_port),$("#bw-download,#bw-upload").makeunit(),$("[name=isp_down],[name=isp_up]").on("click",function(){this.select()}),$("[name=isp_down]").val(fv.isp_down),$("[name=isp_up]").val(fv.isp_up),$.each(fv.profiles,function(e,a){var t;0==e?(t=$("#profiles .panel:first"),$("[name=dns-select]",t).makecombo(),$("table.qos input",t).makeunit()):t=addProfile(a.name),$("[name=rate_down],[name=max_down],[name=rate_up],[name=max_up]",t).on("click",function(){this.select()}),syncDNSSelection(t,a.dns),$("input[name=block_ad]",t).prop("checked",a.block_ad),$("input[name=enable_pc]",t).prop("checked",a.enable_pc),$("input[name=safe_search]",t).prop("checked",a.safe_search),$("input[name*=yt_restricted][value="+a.yt_restricted+"]",t).prop("checked",!0),$("input[name=block_literal_ip]",t).prop("checked",a.block_literal_ip&&a.enable_pc),$("input[name=block_proxy]",t).prop("checked",a.block_proxy&&a.enable_pc),$("input[name=block_proxy2]",t).prop("checked",a.block_proxy2&&a.enable_pc),$("[name=blocked_urls]",t).val(a.blocked_urls.join("\n")),$("[name=allowed_urls]",t).val(a.allowed_urls.join("\n")),$("[name*=url_block_mode][value="+a.url_block_mode+"]",t).prop("checked",!0),t.data("pausable","1"!=fv.disabled&&a.enable_pc),t.data("pausable")&&0<a.calendars.length&&$.each(a.calendars,function(e,a){a.pausable=!0}),refreshCalendarList(e,a.enable_pc?a.calendars:null);for(var s=["rate_down","max_down","rate_up","max_up"],r=0;r<s.length;r++)$("[name="+s[r]+"]",t).val(a[s[r]])}),toggleAuthProxySettings(),refreshProfileSelect();var s=[];if($.each(fv.auth_proxy_users,function(e,a){a.proxy=!0,s.push(a)}),$.each(fv.vpn_users,function(e,a){s.push(a)}),s.sort(function(e,a){return e.name.toUpperCase()>a.name.toUpperCase()?1:-1}),$.each(s,function(e,a){var t=null;a.proxy&&((t=$("<tr><td>"+a.name+"</td><td></td></tr>")).data("username",a.name).data("oldname",a.name),$("#users tr:last").before(t)),assignUserProfile(a.name,t,a.profile)}),fv.devices.sort(function(e,a){return e.name.toUpperCase()>a.name.toUpperCase()?1:-1}),$.each(fv.devices,function(e,a){$("#profiles .panel:eq("+a.profile+") .device-list").append('<li class="option-list"><span class="list-remove pull-right">&nbsp;</span>'+a.name+"</li>")}),"1"!=fv.disabled){$(".settings-header h3 a").show();var n=$("#profiles .panel-collapse.in");$("[name=enable_pc]",n).prop("checked")&&(n.prev().find(".profile.pause").data("click",0).removeClass("disabled"),n.find(".calendar.pause").parent().parent().find(".btn-calendar").each(function(e,a){if($(a).data("pausable"))return n.find(".calendar.pause").removeClass("disabled"),!1}))}else $(".settings-header h3 a").hide();$("#profiles .panel").each(function(){toggleProfileParentalControl($("input[name=enable_pc]",$(this)))}),$('button[type="submit"]').on("click",function(e){if(e.preventDefault(),validateForm()){var a=$(this).parents("form"),t={messages:{url_blocked:$("#msg-url-blocked").text(),site_closed:$("#msg-site-closed").text()},auth_proxy:$("[name=proxy]").prop("checked"),auth_proxy_port:$("[name=proxy-port]").val(),auth_proxy_users:[],cbtoken:$("#cbtoken").val(),isp_down:$("[name=isp_down]").val(),isp_up:$("[name=isp_up]").val(),devices:fv.devices,profiles:fv.profiles};$("#users tr:gt(0)").each(function(){if($(this).is(":last-child"))return!1;t.auth_proxy_users.push({oldname:$(this).data("oldname"),name:$(this).data("username"),password:$(this).data("password"),profile:parseInt($(this).data("profile"))})}),t.vpn_users=fv.vpn_users,$("#profiles .panel").each(function(){var e=t.profiles[$(this).index()];e.block_ad=$("[name=block_ad]",$(this)).prop("checked"),e.enable_pc=$("[name=enable_pc]",$(this)).prop("checked"),e.safe_search=$("[name=safe_search]",$(this)).prop("checked"),e.yt_restricted=$("[name*=yt_restricted]:checked",$(this)).val(),e.block_literal_ip=$("[name=block_literal_ip]",$(this)).prop("checked"),e.block_proxy=$("[name=block_proxy]",$(this)).prop("checked"),e.block_proxy2=$("[name=block_proxy2]",$(this)).prop("checked"),e.dns=[$("[name=dns1]",$(this)).val(),$("[name=dns2]",$(this)).val()],e.blocked_urls=$("[name=blocked_urls]",$(this)).val().split(/\r?\n/).filter(function(e){return 0<e.trim().length}),e.allowed_urls=$("[name=allowed_urls]",$(this)).val().split(/\r?\n/).filter(function(e){return 0<e.trim().length}),e.url_block_mode=$("[name*=url_block_mode]:checked",$(this)).val(),e.rate_down=$("[name=rate_down]",$(this)).val(),e.max_down=$("[name=max_down]",$(this)).val(),e.rate_up=$("[name=rate_up]",$(this)).val(),e.max_up=$("[name=max_up]",$(this)).val()}),pcwrt.submit_form(a,JSON.stringify(t),{error:function(e){var a=e.message;$.each(a.profiles,function(s,r){r.errs&&$.each(["blocked_urls","allowed_urls"],function(e,a){var t;r.errs[a]&&$("#profiles .panel:eq("+s+") [name="+a+"]").parent().addClass("has-error").append('<p class="form-control-error">'+r.errs[a]+"</p>")})})},success:function(e){$("#pc-status").text(msgs.enabled).parent().removeClass("alert-danger").addClass("alert-success"),$("#disable-pc").removeClass("hidden"),$("#enable-pc").addClass("hidden"),$("#enable-disable").removeClass("hidden"),$("#enable-alert").addClass("hidden"),$(".settings-header h3 a").show(),$("[name=isp_down],[name=isp_up]").each(function(){/^\d+(\.\d*)?[km]$/.test($(this).val())||$(this).val("1000m")}),$(".panel [name=rate_down],[name=rate_up]").each(function(){/^\d+(\.\d*)?[km]$/.test($(this).val())||$(this).val("0m")}),$(".panel [name=max_down],[name=max_up]").each(function(){/^\d+(\.\d*)?[km]$/.test($(this).val())&&!/^0(\.0*)?[km]$/.test($(this).val())||$(this).val("Unlimitedm")}),pcwrt.apply_changes(e.apply,function(e){$("#users tr:gt(0)").each(function(){if($(this).is(":last-child"))return!1;$(this).data("oldname",$(this).data("username"))});var s=1;$("#profiles .panel").each(function(e,t){$.each(fv.profiles[e].calendars,function(e,a){a.id=s,$(".btn-calendar:eq("+e+")",$(t)).data("id",s),s++}),$(t).data("pausable",$("[name=enable_pc]",$(t)).prop("checked")),$(t).find(".btn-calendar").data("pausable",$(t).data("pausable")),0<$(".btn-calendar",$(t)).length&&$(t).find(".calendar.pause").removeClass("disabled"),$(".panel-collapse",$(t)).hasClass("in")&&$(t).data("pausable")&&$(t).find(".profile.pause").data("click",0).removeClass("disabled")})})}},"application/json")}}),$("#profiles").on("hidden.bs.collapse",".panel",function(e){$(this).find(".profile.pause").addClass("disabled")}),$("#profiles").on("shown.bs.collapse",".panel",function(e){var t=$(this);t.data("pausable")&&(t.find(".profile.pause").data("click",0).removeClass("disabled"),t.find(".calendar.pause").parent().parent().find(".btn-calendar").each(function(e,a){if($(a).data("pausable"))return t.find(".calendar.pause").removeClass("disabled"),!1}))}),$("#cbtoken").on("blur",function(e){var a=$(this).val().trim();$("#cbform [name=cbtoken]").val(a),pcwrt.submit_form($("#cbform"),$("#cbform").serialize(),{error:function(e){pcwrt.show_message(window.msgs.cb_sync_title,e.message,function(){$("#cbtoken").focus()})},success:function(e){0<a.length&&pcwrt.show_message(window.msgs.cb_sync_title,window.msgs.cb_sync_message),fv.dns_options=e.dns_options,$("#profiles .panel").each(function(){var e=$(this),a=$("[name=dns-select]",e).val();$("[name=dns-select]",e).data("makecombo",null).next().remove(),refreshDNSSelectionList(e),$("[name=dns-select]",e).makecombo(),syncDNSSelection(e,"default"==a?[]:[$("[name=dns1]",e).val(),$("[name=dns2]",e).val()])})}})})});