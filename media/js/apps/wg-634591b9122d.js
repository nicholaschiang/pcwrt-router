function display_disabled(){$("#wg-status").text(msgs.disabled).parent().removeClass("alert-success").addClass("alert-danger"),$("#enable-wg").removeClass("hidden"),$("#disable-wg").addClass("hidden"),$("#restart-wg").addClass("hidden"),$("#wg-settings").slideUp()}function disable_wg(e){pcwrt.submit_form(e,JSON.stringify({enabled:"0"}),function(e){display_disabled(),pcwrt.apply_changes(e.apply)})}function valid_wg_key(e){return 44==e.trim().length}function update_wg_conn(){var e;$("#wg-conns tr:gt(0)").each(function(){return!$(this).is(":last-child")&&($("#conn-modal input[name=oldconnname]").val()==$(this).data("oldconnname")?(e=$(this),!1):void 0)}),e?$("td:first",e).html('<span class="glyphicon glyphicon-play pull-right control" title="Start"></span><span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span><span class="glyphicon glyphicon-list-alt pull-right logs" title="View log" style="display:none"></span>'+$("#connname").val().trim()):(e=$('<tr><td><span class="glyphicon glyphicon-play pull-right control" title="Start"></span><span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span><span class="glyphicon glyphicon-list-alt pull-right logs" title="View log" style="display:none"></span>'+$("#connname").val().trim()+'</td><td class="text-center"><input type="checkbox" name="autostart"></td></tr>'),$("#wg-conns tr:last").before(e)),e.data("oldconnname",$("#connname").val().trim()),e.data("ip",$("#cliip").val().trim()),e.data("port",$("#cliport").val().trim()),e.data("privatekey",$("#cliprivkey").val().trim()),e.data("publickey",$("#clipubkey").val().trim()),e.data("dns",$("#clidns").val().trim()),e.data("serverpubkey",$("#svrpubkey").val().trim()),e.data("presharedkey",$("#presharedkey").val().trim()),e.data("serverhost",$("#svrhost").val().trim()),e.data("serverport",$("#svrport").val().trim()),$("#wg-conns").data("uncommitted",!0)}function display_conn_edit(e,t){$("#conn-modal").find(".modal-title").text(window.msgs.edit_wg_conn_title).end().find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end().find("input:not([type=radio],[type=checkbox])").val("").end().find("input[name=connname]").val(t).end().find("input[name=svrhost]").val(e.data("serverhost")).end().find("input[name=svrport]").val(e.data("serverport")).end().find("input[name=presharedkey]").val(e.data("presharedkey")).end().find("input[name=svrpubkey]").val(e.data("serverpubkey")).end().find("input[name=cliprivkey]").val(e.data("privatekey")).end().find("input[name=clipubkey]").val(e.data("publickey")).end().find("input[name=cliip]").val(e.data("ip")).end().find("input[name=cliport]").val(e.data("port")).end().find("input[name=clidns]").val(e.data("dns")).end().find("input[name=oldconnname]").val(e.data("oldconnname")).end().modal("show")}$("#pubkey").on("change",function(e){$("#privkey").val("")}),$("#wg-conns").on("click","input",function(e){$(this).prop("checked")&&$(this).parent().parent().siblings().find("input[type=checkbox]").prop("checked",!1)}),$("#reinit-wg").on("click",function(e){e.preventDefault(),pcwrt.submit_form($("#wg-init"),{},function(e){$("#publickey").val(e.svrpubkey)})}),$("#peers .btn").on("click",function(e){e.preventDefault(),$("#add-peer .form-group").removeClass("has-error").find("p.form-control-error").remove(),$("#add-peer .modal-title").text(window.msgs.add_wg_peer),$("#add-peer").data("row",null).modal("show"),$("[name=vpnout]:first").prop("checked",!0),$("#privkey").val(""),$("#pubkey").val(""),$("#peerip").val(""),$("#peerdns").val(""),$("#peername").val("").focus()}),$("#add-peer .btn-success").on("click",function(e){if(e.preventDefault(),$("#add-peer .form-group").removeClass("has-error").find("p.form-control-error").remove(),/^[a-zA-Z0-9._\-\\\$@%#&]+$/.test($("#peername").val())){var t,n=$("#add-peer").data("row");n&&0==(t=$("#peers tr:eq("+$("#add-peer").data("row")+")")).length&&(t=null);var a=null;$("#peers tr:gt(0)").each(function(){$(this).is(":last-child")||$(this).index()!=n&&$("td:first",$(this)).text().trim()==$("#peername").val()&&(a="duplicate")}),"duplicate"!=a?valid_wg_key($("#pubkey").val())?(t||(t=$('<tr><td></td><td></td><td class="text-center"><input type="checkbox" name="guest"></td></tr>'),$("#peers tr:last").before(t)),$("td:first",t).html('<span class="pull-right list-remove" title="Delete peer">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span><span class="pull-right glyphicon glyphicon-download-alt control" title="Download WireGuard peer config"></span>'+(pcwrt.is_empty($("#privkey").val())?"":'<span class="pull-right glyphicon glyphicon-qrcode control" title="Download QR code"></span>')+$("#peername").val()),$("td:eq(1)",t).text("1"==$("[name=vpnout]:checked").val()?window.msgs.vpn:window.msgs.isp),t.data("peername",null),t.data("pubkey",$("#pubkey").val().trim()),t.data("privkey",$("#privkey").val().trim()),$("#add-peer").modal("hide")):$("#pubkey").after('<p class="form-control-error">'+window.msgs.invalid_peer_public_key+"</p>").parent().addClass("has-error"):$("#peername").after('<p class="form-control-error">'+window.msgs.peer_name_exists+"</p>").parent().addClass("has-error")}else $("#peername").after('<p class="form-control-error">'+window.msgs.enter_valid_peer_name+"</p>").parent().addClass("has-error")}),$("#peers").on("click",".list-remove",function(e){e.preventDefault(),$("#peers").data("deletePeer",$(this).parents("tr").index()),pcwrt.confirm_action(window.msgs.delete_peer_title,window.msgs.delete_peer_confirm+' "'+$(this).parent().text().trim()+'"?',function(){var e=$("#peers").data("deletePeer"),t;$("#peers tr:eq("+e+") td:first").text().trim()==$("#connect-wg [name=cfg]").val()&&$("#connect-wg [name=cfg]").val(""),$("#peers tr:eq("+e+")").remove()})}),$("#peers").on("click",".list-edit",function(e){e.preventDefault(),$("#add-peer .form-group").removeClass("has-error").find("p.form-control-error").remove();var t=$(this).parent().parent(),n=$(this).parent().next().text()==window.msgs.vpn;t.data("peername")?($("#get-peer-info [name=peername]").val($(this).parent().text().trim()),pcwrt.fetch_data($("#get-peer-info").attr("action"),{peername:$("#get-peer-info [name=peername]").val()},function(e){$("#add-peer [name=peername]").val($("#get-peer-info [name=peername]").val()),$("#add-peer [name=privkey]").val(e.privatekey),$("#add-peer [name=pubkey]").val(e.publickey),$("#add-peer [name=peerip]").val(e.ip),$("#add-peer [name=peerdns]").val(e.dns),t.data("peerip",e.ip),t.data("peerdns",e.dns),n?$("[name=vpnout]:eq(1)").prop("checked",!0):$("[name=vpnout]:eq(0)").prop("checked",!0),$("#add-peer .modal-title").text(window.msgs.edit_wg_peer),$("#add-peer").data("row",t.index()).modal("show")})):($("#add-peer [name=peername]").val($("td:first",t).text().trim()),$("#add-peer [name=privkey]").val(t.data("privkey")),$("#add-peer [name=pubkey]").val(t.data("pubkey")),$("#add-peer [name=peerip]").val(t.data("ip")),$("#add-peer [name=peerdns]").val(t.data("dns")),$("#add-peer .modal-title").text(window.msgs.edit_wg_peer),n?$("[name=vpnout]:eq(1)").prop("checked",!0):$("[name=vpnout]:eq(0)").prop("checked",!0),$("#add-peer").data("row",t.index()).modal("show"))}),$("#peers").on("click",".glyphicon-download-alt",function(e){e.preventDefault(),$(this).parent().parent().data("peername")?($("#password").val(""),$("#wg-password").data("peername",$(this).parent().parent().data("peername")).modal("show")):pcwrt.show_message(msgs.peer_not_saved_title,msgs.peer_not_saved)}),$("#wg-password .btn-success").on("click",function(e){e.preventDefault(),$("#wg-password").modal("hide"),$("#download-peer-conf").find("[name=peername]").val($("#wg-password").data("peername")).end().find("[name=password]").val($("#password").val()),window.location.href=$("#download-peer-conf").attr("action")+"?"+$("#download-peer-conf").serialize()}),$("#peers").on("click",".glyphicon-qrcode",function(e){e.preventDefault();var t=$(this).parent().text().trim();if($(this).parent().parent().data("peername")){$("#show-peer-qr").find("h4").text(window.msgs.scan_qr_code_for+" "+t).end().find("img").remove().end();var n=new Image;n.onload=function(){$("#show-peer-qr").find(".modal-body").append(n).end().modal("show"),pcwrt.hideOverlay()},$("#download-peer-qr [name=peername]").val(t),n.src=$("#download-peer-qr").attr("action")+"?"+$("#download-peer-qr").serialize(),$("#spinner strong").text(window.msgs.fetching_qr_code),pcwrt.showOverlay($("#spinner"))}else pcwrt.show_message(msgs.peer_not_saved_title,msgs.peer_not_saved)}),$("#add-wg-conn").on("click",function(e){e.preventDefault(),$("#conn-modal").find(".modal-title").text(window.msgs.add_wg_conn_title).end().find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end().find("input:not([type=radio],[type=checkbox])").val("").end().modal("show");var t=Math.floor(64511*Math.random()+1024);$("#cliport").val(t)}),$("#upload-conn-config").on("click",function(e){e.preventDefault(),$("#conn-config-modal").find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end().find("input:not([type=radio],[type=checkbox])").val("").end().modal("show")}),$("#gen-client-key").on("click",function(e){e.preventDefault(),pcwrt.submit_form($("#client-init"),{},function(e){$("#cliprivkey").val(e.privatekey),$("#clipubkey").val(e.publickey)})}),$("#gen-peer-key").on("click",function(e){e.preventDefault(),pcwrt.submit_form($("#client-init"),{},function(e){$("#pubkey").val(e.publickey),$("#privkey").val(e.privatekey)})}),$("#conn-config-modal").on("hidden.bs.modal",function(e){$("#conn-modal").modal("hide").modal("show")}),$("#conn-config-modal form").ajaxForm({beforeSubmit:function(e,t,n){$("#conn-config-modal .form-control-error").parent().removeClass("has-error").end().remove()},complete:function(e){var t=e.responseJSON;"success"==t.status?($("#svrhost").val(t.serverhost),$("#svrport").val(t.serverport),$("#svrpubkey").val(t.serverpubkey),$("#presharedkey").val(t.presharedkey),$("#cliprivkey").val(t.privatekey),$("#clipubkey").val(t.publickey),$("#cliip").val(t.ip),$("#cliport").val(t.port),$("#clidns").val(t.dns),$("#conn-config-modal").modal("hide")):"error"==t.status?t.message&&(t.message.wgconfigfile&&$("#wgconfig-group").addClass("has-error").append('<p class="form-control-error">'+t.message.wgconfigfile+"</p>"),t.message.decpass&&$("#decpass").parent().addClass("has-error").append('<p class="form-control-error">'+t.message.decpass+"</p>")):"login"==t.status?location.reload(!0):($("#status-modal .modal-title").text(window.msgs.oops),$("#status-modal .modal-body p").text(t.message),$("#status-modal").modal("show"))}}),$("#conn-modal .btn-success").on("click",function(e){e.preventDefault(),$("#conn-modal .form-group").removeClass("has-error").find("p").remove();var n=!0;if(pcwrt.is_empty($("#connname").val())?($("#conn-modal .form-group:first").addClass("has-error").append('<p class="form-control-error">'+window.msgs.empty_conn_name+"</p>"),n=!1):/^[a-zA-Z0-9._\-\\\$@%#& ]+$/.test($("#connname").val())?$("#wg-conns tr:gt(0)").each(function(){return!$(this).is(":last-child")&&($(this).data("oldconnname")==$("#connname").val().trim()&&$("#oldconnname").val()!=$(this).data("oldconnname")?($("#conn-modal .form-group:first").addClass("has-error").append('<p class="form-control-error">'+window.msgs.duplicate_conn+"</p>"),n=!1):void 0)}):($("#conn-modal .form-group:first").addClass("has-error").append('<p class="form-control-error">'+window.msgs.enter_valid_conn_name+"</p>"),n=!1),pcwrt.is_valid_hostname($("#svrhost").val().trim())||pcwrt.is_valid_ipaddr($("#svrhost").val().trim())||($("#svrhost").parents(".form-group").addClass("has-error").append('<p class="form-control-error">'+window.msgs.invalid_host_name+"</p>"),n=!1),pcwrt.is_valid_port($("#svrport").val().trim())||($("#svrport").parents(".form-group").addClass("has-error").append('<p class="form-control-error">'+window.msgs.invalid_port+"</p>"),n=!1),valid_wg_key($("#svrpubkey").val())||($("#svrpubkey").parents(".form-group").addClass("has-error").append('<p class="form-control-error">'+window.msgs.empty_server_public_key+"</p>"),n=!1),valid_wg_key($("#cliprivkey").val())||($("#cliprivkey").parents(".form-group").addClass("has-error").append('<p class="form-control-error">'+window.msgs.empty_client_private_key+"</p>"),n=!1),pcwrt.is_valid_ipaddr($("#cliip").val())||($("#cliip").parents(".form-group").addClass("has-error").append('<p class="form-control-error">'+window.msgs.invalid_client_ip+"</p>"),n=!1),n){if(pcwrt.is_empty($("#clidns").val()))n=!1,pcwrt.confirm_action(window.msgs.confirm_default_dns_title,window.msgs.confirm_default_dns,function(){$("#clidns").val("1.1.1.1, 1.0.0.1"),$("#conn-modal .form-group").removeClass("has-error").find("p").remove(),n=!0});else{var t=$("#clidns").val().split(/[, ]+/);$.each(t,function(e,t){if(!pcwrt.is_valid_ipaddr(t))return n=!1})}n?(update_wg_conn(),$("#conn-modal").modal("hide")):$("#clidns").parents(".form-group").addClass("has-error").append('<p class="form-control-error">'+window.msgs.invalid_client_dns+"</p>")}}),$("#conn-config-modal .btn-file:first :file").on("fileselect",function(e,t,n){$("#conn-config-modal [name=wgconfig-name]").val(n)}),$('#wg-clients button[type="submit"]').on("click",function(e){e.preventDefault();var n={networks:[],conns:[],splittunnel:{}};$("#wg-clients [name=network]").each(function(){$(this).prop("checked")&&n.networks.push($(this).val())}),$("#wg-conns tr:gt(0)").each(function(){if($(this).is(":last-child"))return!1;n.conns.push({name:$(this).data("oldconnname"),ip:$(this).data("ip"),port:$(this).data("port"),privatekey:$(this).data("privatekey"),publickey:$(this).data("publickey"),dns:$(this).data("dns"),presharedkey:$(this).data("presharedkey"),serverpubkey:$(this).data("serverpubkey"),serverhost:$(this).data("serverhost"),serverport:$(this).data("serverport"),autostart:$(this).find("[name=autostart]").prop("checked")})}),n.splittunnel.mode=$("#wg-clients [name=splitmode]:checked").val(),n.splittunnel.domains=[],$.each($("#wg-clients [name=domains]").val().split(/\r?\n/),function(e,t){n.splittunnel.domains.push(t)});var t=$(this).parents("form");pcwrt.submit_form(t,JSON.stringify(n),function(e){$("#wg-conns").data("uncommitted",null),pcwrt.apply_changes(e.apply)},"application/json")}),$('#wg-update button[type="submit"]').on("click",function(e){e.preventDefault();var t={extaddr:$("#extaddr").val().trim(),port:$("#port").val().trim(),ipaddr:$("#ipaddr").val().trim(),netmask:$("#netmask").val().trim(),peers:[]};$("#peers tr:gt(0)").each(function(){if($(this).is(":last-child"))return!1;t.peers.push({name:$("td:first",$(this)).text().trim(),pubkey:$(this).data("pubkey"),privkey:$(this).data("privkey"),create:null==$(this).data("peername"),guest:$("[name=guest]",$(this)).prop("checked"),vpnout:$("td:eq(1)",$(this)).text()==window.msgs.vpn})});var n=$(this).parents("form");pcwrt.submit_form(n,JSON.stringify(t),function(e){$("#peers tr").each(function(){if($(this).is(":last-child"))return!1;$(this).data("peername",$("td:first",$(this)).text().trim())}),$("#publickey").val(e.svrpubkey),$("#wg-status").text(msgs.enabled).parent().removeClass("alert-danger").addClass("alert-success"),$("#disable-wg").removeClass("hidden"),$("#restart-wg").removeClass("hidden"),$("#enable-wg").addClass("hidden"),$("#enable-disable").removeClass("hidden"),$("#enable-alert").addClass("hidden"),pcwrt.apply_changes(e.apply)},"application/json")}),$("#enable-wg").on("click",function(e){e.preventDefault(),$("#enable-disable").addClass("hidden"),$("#enable-alert").removeClass("hidden"),$("#wg-settings").slideDown()}),$("#disable-wg").on("click",function(e){var t;e.preventDefault(),disable_wg($(this).parents("form"))}),$("#restart-wg").on("click",function(e){e.preventDefault(),pcwrt.submit_form($("#restart-server"),{},function(e){pcwrt.show_message(msgs.restart_wg_title,msgs.restart_wg_message)})}),$("#wg-conns").on("click",".list-remove",function(e){e.preventDefault(),$("#wg-conns").data("deleteConfig",$(this).parents("tr").index()),pcwrt.confirm_action(window.msgs.delete_wg_conn_title,window.msgs.delete_wg_conn_confirm+' "'+$(this).parent().text().trim()+'"?',function(){var e=$("#wg-conns").data("deleteConfig");$("#wg-conns tr:eq("+e+")").remove(),$("#wg-conns").data("uncommitted",!0)})}),$("#wg-conns").on("click",".list-edit",function(e){e.preventDefault();var t=$(this).parent().parent();t.data("privatekey")?display_conn_edit(t,$(this).parent().text().trim()):pcwrt.fetch_data($("#get-connparms").attr("action"),{cfg:t.data("oldconnname")},function(e){t.data("serverhost",e.serverhost),t.data("serverport",e.serverport),t.data("serverpubkey",e.serverpubkey),t.data("presharedkey",e.presharedkey),t.data("privatekey",e.privatekey),t.data("publickey",e.publickey),t.data("ip",e.ip),t.data("port",e.port),t.data("dns",e.dns),display_conn_edit(t,e.name)})}),$("#wg-conns").on("click","span.glyphicon.logs",function(e){e.preventDefault(),pcwrt.fetch_data($("#get-clientlog").attr("action"),{},function(e){$("#logs-modal").find("#client-logs").html(pcwrt.is_empty(e)?window.msgs.logs_empty:e).end().modal("show")})}),$("#wg-conns").on("click","span.glyphicon.control",function(e){if(e.preventDefault(),$("#wg-conns").data("uncommitted"))pcwrt.show_message(msgs.uncommitted_title,msgs.uncommitted_changes);else{var t=$(this);if(t.hasClass("glyphicon-play")){var n=$("#connect-wg");$("[name=action]",n).val("start"),$("[name=cfg]",n).val(t.parents("td:first").text().trim()),pcwrt.submit_form(n,n.serialize(),function(e){t.parents("td:first").removeClass("running connected stopped"),"running"!=e.state&&"connected"!=e.state&&"stopped"!=e.state||(t.parents("td:first").addClass(e.state).parent().siblings().find("td:first").removeClass("running connected stopped").find("span.logs").hide(),t.parents("tr:first").siblings().find("span.glyphicon.control").removeClass("glyphicon-stop").addClass("glyphicon-play"),t.removeClass("glyphicon-play").addClass("glyphicon-stop").attr("title","Stop").parents("td:first").find("span.logs").show())},null,!1,window.msgs.start_wgconf+' "'+$("[name=cfg]",n).val()+'"')}else{var n=$("#connect-wg");$("[name=action]",n).val("stop"),$("[name=cfg]",n).val(t.parents("td:first").text().trim()),pcwrt.submit_form(n,n.serialize(),function(e){t.parents("td:first").removeClass("running connected").addClass("stopped"),t.removeClass("glyphicon-stop").addClass("glyphicon-play").attr("title","Start")},null,!1,window.msgs.stop_wgconf+' "'+$("[name=cfg]",n).val()+'"')}}}),$(function(){var r=$("[name=network]:first").parent().parent();$.each(fv.client.enabled_network,function(e,t){if(0<e){var n=r.clone();r.after(n),r=n}var a=$("label",r).contents();a[a.length-1].nodeValue=t.text,$("input",r).prop("value",t.name),$("input",r).prop("checked",!!t.enabled)}),fv.client.conns&&(fv.client.conns.sort(function(e,t){return e.name.toUpperCase()>t.name.toUpperCase()?1:-1}),$.each(fv.client.conns,function(e,t){var n=$('<tr><td><span class="glyphicon glyphicon-play pull-right control" title="Start"></span><span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span><span class="glyphicon glyphicon-list-alt pull-right logs" title="View log" style="display:none"></span>'+t.name+'</td><td class="text-center"><input type="checkbox" name="autostart"></td></tr>');"1"==t.autostart&&n.find("[name=autostart]").prop("checked",!0),"connected"!=t.state&&"running"!=t.state&&"stopped"!=t.state||($("#connect-wg [name=cfg]").val(t.name),n.find("td:first").addClass(t.state).find("span.logs").show(),"stopped"!=t.state&&n.find(".glyphicon.control").removeClass("glyphicon-play").addClass("glyphicon-stop").attr("title","Stop")),n.data("oldconnname",t.name),$("#wg-conns tr:last").before(n)})),$("#wg-clients [name=splitmode]").each(function(){if(fv.client.splitmode==$(this).val())return $(this).prop("checked",!0),!1}),$("#wg-clients [name=domains]").val(fv.client.domains.sort(function(e,t){return e.toUpperCase()>t.toUpperCase()?1:-1}).join("\r\n")),pcwrt.populate_forms(fv.server),fv.server.peers.sort(function(e,t){return e.name.toUpperCase()>t.name.toUpperCase()?1:-1}),$.each(fv.server.peers,function(e,t){var n=$('<tr><td><span class="pull-right list-remove" title="Delete peer">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span><span class="pull-right glyphicon glyphicon-download-alt control" title="Download WireGuard peer config"></span>'+(t.qr?'<span class="pull-right glyphicon glyphicon-qrcode control" title="Download QR code"></span>':"")+t.name+"</td><td>"+(t.vpnout?window.msgs.vpn:window.msgs.isp)+'</td><td class="text-center"><input type="checkbox" name="guest"'+(t.guest?" checked":"")+"></td></tr>");$("#peers tr:last").before(n),n.data("peername",t.name)}),"0"==fv.server.enabled?($("#enable-disable").addClass("alert-danger").removeClass("alert-success"),$("#wg-status").text(window.msgs.disabled),$("#enable-wg").removeClass("hidden")):($("#enable-disable").removeClass("alert-danger").addClass("alert-success"),$("#wg-status").text(window.msgs.enabled),$("#disable-wg").removeClass("hidden"),$("#restart-wg").removeClass("hidden"),$("#wg-settings").slideDown()),window.setInterval(function(){var e=$("#connect-wg"),t=$("[name=cfg]",e).val();pcwrt.is_empty(t)||pcwrt.fetch_data(e.data("state_url"),{cfg:t},function(e){var t=null;$("#wg-conns tr:gt(0)").find("td:first").removeClass("running connected stopped").each(function(){$(this).find("span.logs").hide(),$(this).text().trim()==e.cfg&&(t=$(this))}),t&&t.addClass(e.state).find("span.logs").show()})},1e4)});