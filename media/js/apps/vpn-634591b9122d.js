function display_disabled(){$("#vpn-status").text(msgs.disabled).parent().removeClass("alert-success").addClass("alert-danger"),$("#enable-vpn").removeClass("hidden"),$("#disable-vpn").addClass("hidden"),$("#restart-vpn").addClass("hidden"),$("#vpn-settings").slideUp()}function disable_vpn(e){pcwrt.submit_form(e,JSON.stringify({enabled:"0"}),function(e){display_disabled(),pcwrt.apply_changes(e.apply)})}function update_vpn_configs(){var e;$("#vpn-configs tr:gt(0)").each(function(){return!$(this).is(":last-child")&&($("#client-modal input[name=oldname]").val()==$(this).data("oldname")?(e=$(this),!1):void 0)}),e?$("td:first",e).html('<span class="glyphicon glyphicon-play pull-right control" title="Start"></span><span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span><span class="glyphicon glyphicon-list-alt pull-right logs" title="View log" style="display:none"></span>'+$("#cfgname").val().trim()):(e=$('<tr><td><span class="glyphicon glyphicon-play pull-right control" title="Start"></span><span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span><span class="glyphicon glyphicon-list-alt pull-right logs" title="View log" style="display:none"></span>'+$("#cfgname").val().trim()+'</td><td class="text-center"><input type="checkbox" name="autostart"></td></tr>'),$("#vpn-configs tr:last").before(e)),e.data("oldname",$("#cfgname").val().trim()),$("#vpn-configs").data("uncommitted",!0)}function toggle_scramble(){$("#scramble").prop("checked")?$("#scrampass").parent().slideDown():$("#scrampass").parent().slideUp()}$("#users .btn").on("click",function(e){e.preventDefault(),$("#user-dialog .form-group").removeClass("has-error").find("p.form-control-error").remove(),$("#user-dialog").modal("show"),$("#username").val("").data("rowname",null).focus(),$("#password").val(""),$("[name=vpnout]:first").prop("checked",!0)}),$("#user-dialog .btn-success").on("click",function(e){if(e.preventDefault(),$("#user-dialog .form-group").removeClass("has-error").find("p.form-control-error").remove(),/^[a-zA-Z0-9._\-\\\$@%#&]+$/.test($("#username").val())){var t=null,s=null;if($("#users tr:gt(0)").each(function(){$(this).is(":last-child")||($(this).data("username")==$("#username").data("rowname")&&(t=$(this)),$(this).data("username")==$("#username").val()&&$(this).data("username")!=$("#username").data("rowname")&&(s="duplicate"))}),"duplicate"!=s){if(t)$("td:eq(0)",t).html('<span class="pull-right list-remove" title="Delete">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span>'+$("#username").val()),$("td:eq(1)",t).text("1"==$("[name=vpnout]:checked").val()?window.msgs.vpn:window.msgs.isp);else{if(/^\s*$/.test($("#password").val()))return void $("#password").after('<p class="form-control-error">'+window.msgs.enter_password+"</p>").parent().addClass("has-error");t=$('<tr><td><span class="pull-right list-remove" title="Delete">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span>'+$("#username").val()+"</td><td>"+("1"==$("[name=vpnout]:checked").val()?window.msgs.vpn:window.msgs.isp)+'</td><td class="text-center"><input type="checkbox" name="guest"></td></tr>'),$("#users tr:last").before(t)}t.data("username",$("#username").val().trim()),/^\**$/.test($("#password").val())||t.data("password",$("#password").val()),$("#user-dialog").modal("hide")}else $("#username").after('<p class="form-control-error">'+window.msgs.user_name_exists+"</p>").parent().addClass("has-error")}else $("#username").after('<p class="form-control-error">'+window.msgs.enter_valid_user_name+"</p>").parent().addClass("has-error")}),$("#users").on("click",".list-remove",function(e){e.preventDefault(),$("#users").data("deleteUser",$(this).parents("tr").index()),pcwrt.confirm_action(window.msgs.delete_user_title,window.msgs.delete_user_confirm+' "'+$(this).parent().text().trim()+'"?',function(){var e=$("#users").data("deleteUser");$("#users tr:eq("+e+")").remove()})}),$("#users").on("click",".list-edit",function(e){e.preventDefault();var t=$(this).parent().text().trim();$("#user-dialog .form-group").removeClass("has-error").find("p.form-control-error").remove(),$("#username").val(t).data("rowname",t),$("#password").val("*******************"),$(this).parent().next().text()==window.msgs.vpn?$("[name=vpnout]:eq(1)").prop("checked",!0):$("[name=vpnout]:eq(0)").prop("checked",!0),$("#user-dialog").modal("show")}),$('#vpn-init button[type="submit"]').on("click",function(e){e.preventDefault();var t=$(this).parents("form");pcwrt.submit_form(t,{},function(e){$("#init-alert").addClass("hidden").next().hide(),$("#prog-alert").removeClass("hidden")})}),$("#reinit-vpn").on("click",function(e){e.preventDefault(),pcwrt.confirm_action(window.msgs.reinit_vpn_title,window.msgs.reinit_vpn_confirm,function(){pcwrt.submit_form($("#vpn-init"),{},function(e){$("#main-form").hide(),$("#prog-alert").removeClass("hidden")})})}),$("#enable-vpn").on("click",function(e){e.preventDefault(),$("#enable-disable").addClass("hidden"),$("#enable-alert").removeClass("hidden"),$("#vpn-settings").slideDown()}),$("#disable-vpn").on("click",function(e){var t;e.preventDefault(),disable_vpn($(this).parents("form"))}),$("#restart-vpn").on("click",function(e){e.preventDefault(),pcwrt.submit_form($("#restart-server"),{},function(e){pcwrt.show_message(msgs.restart_vpn_title,msgs.restart_vpn_message)})}),$('#vpn-update button[type="submit"]').on("click",function(e){e.preventDefault();var t={port:$("#port").val(),extaddr:$("#extaddr").val(),ipaddr:$("#ipaddr").val(),netmask:$("#netmask").val(),scramble:$("#scramble").prop("checked")?"1":"0",scrampass:$("#scrampass").val(),users:[]};$("#users tr:gt(0)").each(function(){if($(this).is(":last-child"))return!1;t.users.push({oldname:$(this).data("oldname"),name:$(this).data("username"),password:$(this).data("password"),guest:$("[name=guest]",$(this)).prop("checked"),vpnout:$("td:eq(1)",$(this)).text()==window.msgs.vpn})});var s=$(this).parents("form");pcwrt.submit_form(s,JSON.stringify(t),function(e){$("#users tr").each(function(){if($(this).is(":last-child"))return!1;$(this).data("oldname",$(this).data("username"))}),$("#vpn-status").text(msgs.enabled).parent().removeClass("alert-danger").addClass("alert-success"),$("#disable-vpn").removeClass("hidden"),$("#restart-vpn").removeClass("hidden"),$("#enable-vpn").addClass("hidden"),$("#enable-disable").removeClass("hidden"),$("#enable-alert").addClass("hidden"),pcwrt.apply_changes(e.apply)},"application/json")}),$("#add-vpn-config").on("click",function(e){e.preventDefault(),$("#new-cfg-msg").show(),$("#update-cfg-msg").hide(),$("#client-modal").find(".modal-title").text(window.msgs.add_vpn_title).end().find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end().find("input").val("").end().modal("show")}),$("#vpn-configs").on("click",".list-remove",function(e){e.preventDefault(),$("#vpn-configs").data("deleteConfig",$(this).parents("tr").index()),pcwrt.confirm_action(window.msgs.delete_vpn_config_title,window.msgs.delete_vpn_config_confirm+' "'+$(this).parent().text().trim()+'"?',function(){var e=$("#vpn-configs").data("deleteConfig"),t;$("#vpn-configs tr:eq("+e+") td:first").text().trim()==$("#connect-vpn [name=cfg]").val()&&$("#connect-vpn [name=cfg]").val(""),$("#vpn-configs tr:eq("+e+")").remove()})}),$("#vpn-configs").on("click",".list-edit",function(e){e.preventDefault();var t=$(this).parent().parent().data("oldname");pcwrt.fetch_data($("#client-modal").data("cfgurl")+"?cfg="+escape(t),"",function(e){$("#client-modal input[name=cfguser]").val(e.cfguser),$("#client-modal input[name=cfgpass]").val(e.cfgpass)}),$("#update-cfg-msg a").attr("href",$("#update-cfg-msg a").data("url")+"?cfg="+escape(t)),$("#new-cfg-msg").hide(),$("#update-cfg-msg").show(),$("#client-modal").find(".modal-title").text(window.msgs.edit_vpn_title).end().find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end().find("input").val("").end().find("input[name=cfgname]").val($(this).parent().text().trim()).end().find("input[name=oldname]").val(t).end().modal("show")}),$("#vpn-configs").on("click","span.glyphicon.logs",function(e){e.preventDefault(),pcwrt.fetch_data($("#get-clientlog").attr("action"),{},function(e){$("#logs-modal").find("#client-logs").html(e).end().modal("show")})}),$("#vpn-configs").on("click","span.glyphicon.control",function(e){if(e.preventDefault(),$("#vpn-configs").data("uncommitted"))pcwrt.show_message(msgs.uncommitted_title,msgs.uncommitted_changes);else{var t=$(this);if(t.hasClass("glyphicon-play")){var s=$("#connect-vpn");$("[name=action]",s).val("start"),$("[name=cfg]",s).val(t.parents("td:first").text().trim()),pcwrt.submit_form(s,s.serialize(),function(e){t.parents("td:first").removeClass("running connected stopped"),"running"!=e.state&&"connected"!=e.state&&"stopped"!=e.state||(t.parents("td:first").addClass(e.state).parent().siblings().find("td:first").removeClass("running connected stopped").find("span.logs").hide(),t.parents("tr:first").siblings().find("span.glyphicon.control").removeClass("glyphicon-stop").addClass("glyphicon-play"),t.removeClass("glyphicon-play").addClass("glyphicon-stop").attr("title","Stop").parents("td:first").find("span.logs").show())},null,!1,window.msgs.start_vpnconf+' "'+$("[name=cfg]",s).val()+'"')}else{var s=$("#connect-vpn");$("[name=action]",s).val("stop"),$("[name=cfg]",s).val(t.parents("td:first").text().trim()),pcwrt.submit_form(s,s.serialize(),function(e){t.parents("td:first").removeClass("running connected").addClass("stopped"),t.removeClass("glyphicon-stop").addClass("glyphicon-play").attr("title","Start")},null,!1,window.msgs.stop_vpnconf+' "'+$("[name=cfg]",s).val()+'"')}}}),$("#vpn-configs").on("click","input",function(e){$(this).prop("checked")&&$(this).parent().parent().siblings().find("input[type=checkbox]").prop("checked",!1)}),$("#client-modal .btn-file :file").on("fileselect",function(e,t,s){$("#client-modal [name=ovpn-name]").val(s)}),$("#cert-modal .btn-file:first :file").on("fileselect",function(e,t,s){$("#cert-modal [name=cacert-name]").val(s)}),$("#cert-modal .btn-file:eq(1) :file").on("fileselect",function(e,t,s){$("#cert-modal [name=clicert-name]").val(s)}),$("#cert-modal .btn-file:eq(2) :file").on("fileselect",function(e,t,s){$("#cert-modal [name=clikey-name]").val(s)}),$("#cert-modal .btn-file:eq(3) :file").on("fileselect",function(e,t,s){$("#cert-modal [name=tlscert-name]").val(s)}),$("#client-modal form").ajaxForm({beforeSubmit:function(e,t,s){$("#client-modal .form-control-error").parent().removeClass("has-error").end().remove();var n=!0,a=t[0].cfgname.value.trim();return a?$("#vpn-configs tr:gt(0)").each(function(){return!$(this).is(":last-child")&&($("td:first",$(this)).text().trim()==a&&t[0].oldname.value!=$(this).data("oldname")?($("#client-modal form .form-group:first").addClass("has-error").append('<p class="form-control-error">'+window.msgs.duplicate_config+"</p>"),n=!1):void 0)}):($("#client-modal form .form-group:first").addClass("has-error").append('<p class="form-control-error">'+window.msgs.empty_config+"</p>"),n=!1),n},complete:function(e){var t=e.responseJSON;if("success"==t.status)update_vpn_configs(),$("#client-modal").modal("hide");else if("error"==t.status)if(t.message){for(name in t.message){var s=$('#client-modal input[name="'+name+'"]:visible');s.parent().hasClass("input-group")&&(s=s.parent()),s.parent().addClass("has-error").append('<p class="form-control-error">'+t.message[name]+"</p>")}t.message.ovpnfile&&$("#client-modal .form-group:eq(1)").addClass("has-error").append('<p class="form-control-error">'+t.message.ovpnfile+"</p>")}else t.need_certs&&($("#cert-modal .form-group").hide(),$.each(t.need_certs,function(e,t){$("#"+t+"-group").show()}),$("#cert-modal").find(".form-group").removeClass("has-error").end().find(".form-control-error").remove().end().find("input").val("").end().find("input[name=cfgname]").val($("#cfgname").val().trim()).end().modal("show"));else"login"==t.status?location.reload(!0):($("#status-modal .modal-title").text(window.msgs.oops),$("#status-modal .modal-body p").text(t.message),$("#status-modal").modal("show"))}}),$("#cert-modal form").ajaxForm({beforeSubmit:function(e,t,s){$("#cert-modal .form-control-error").parent().removeClass("has-error").end().remove();var n=!0;return $("#cert-modal .form-group").each(function(){if($(this).is(":visible")&&!$(this).find("input[type=file]").val()){var e=msgs["select_"+$(this).attr("id").replace("-group","")+"_file"];$(this).addClass("had-error").append('<p class="form-control-error">'+e+"</p>"),n=!1}}),n},complete:function(e){var t=e.responseJSON;"success"==t.status?(update_vpn_configs(),$("#cert-modal").modal("hide"),$("#client-modal").modal("hide")):"error"==t.status?(t.message.cacert&&$("#cert-modal .form-group:eq(0)").addClass("has-error").append('<p class="form-control-error">'+t.message.cacert+"</p>"),t.message.clicert&&$("#cert-modal .form-group:eq(1)").addClass("has-error").append('<p class="form-control-error">'+t.message.clicert+"</p>"),t.message.clikey&&$("#cert-modal .form-group:eq(2)").addClass("has-error").append('<p class="form-control-error">'+t.message.clikey+"</p>"),t.message.tlscert&&$("#cert-modal .form-group:eq(3)").addClass("has-error").append('<p class="form-control-error">'+t.message.tlscert+"</p>")):"login"==t.status?location.reload(!0):($("#status-modal .modal-title").text(window.msgs.oops),$("#status-modal .modal-body p").text(t.message),$("#status-modal").modal("show"))}}),$('#vpn-clients button[type="submit"]').on("click",function(e){e.preventDefault();var t=$(this).parents("form"),s=t.serializeArray(),n=null;$("#vpn-configs tr:gt(0)").each(function(){if($(this).is(":last-child"))return!1;!n&&$("td:eq(1) [name=autostart]",$(this)).prop("checked")&&(n=$("td:first",$(this)).text().trim()),s.push({name:"cfgname",value:$("td:first",$(this)).text().trim()})}),$.each(s,function(e,t){if("autostart"==t.name)return t.value=n,!1}),pcwrt.submit_form(t,s,function(e){$("#vpn-configs").data("uncommitted",null),pcwrt.apply_changes(e.apply)})}),$("#scramble").on("click",function(){toggle_scramble()}),$(function(){var a=$("[name=network]:first").parent().parent();$.each(fv.client.enabled_network,function(e,t){if(0<e){var s=a.clone();a.after(s),a=s}var n=$("label",a).contents();n[n.length-1].nodeValue=t.text,$("input",a).prop("value",t.name),$("input",a).prop("checked",!!t.enabled)}),fv.client.clients&&(fv.client.clients.sort(function(e,t){return e.name.toUpperCase()>t.name.toUpperCase()?1:-1}),$.each(fv.client.clients,function(e,t){var s=$('<tr><td><span class="glyphicon glyphicon-play pull-right control" title="Start"></span><span class="pull-right list-remove" title="Remove">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span><span class="glyphicon glyphicon-list-alt pull-right logs" title="View log" style="display:none"></span>'+t.name+'</td><td class="text-center"><input type="checkbox" name="autostart"></td></tr>');t.name==fv.client.autostart&&s.find("[name=autostart]").prop("checked",!0),"connected"!=t.state&&"running"!=t.state&&"stopped"!=t.state||($("#connect-vpn [name=cfg]").val(t.name),s.find("td:first").addClass(t.state).find("span.logs").show(),"stopped"!=t.state&&s.find(".glyphicon.control").removeClass("glyphicon-play").addClass("glyphicon-stop").attr("title","Stop")),s.data("oldname",t.name),$("#vpn-configs tr:last").before(s)})),$("#vpn-clients [name=splitmode]").each(function(){if(fv.client.splitmode==$(this).val())return $(this).prop("checked",!0),!1}),$("#vpn-clients [name=domains]").val(fv.client.domains.sort(function(e,t){return e.toUpperCase()>t.toUpperCase()?1:-1}).join("\r\n")),pcwrt.populate_forms(fv.server),toggle_scramble(),fv.server.users&&(fv.server.users.sort(function(e,t){return e.name.toUpperCase()>t.name.toUpperCase()?1:-1}),$.each(fv.server.users,function(e,t){var s=$('<tr><td><span class="pull-right list-remove" title="Delete">&nbsp;</span><span class="pull-right list-edit" title="Edit">&nbsp;</span>'+t.name+"</td><td>"+(t.vpnout?window.msgs.vpn:window.msgs.isp)+'</td><td class="text-center"><input type="checkbox" name="guest"'+(t.guest?" checked":"")+"></td></tr>");$("#users tr:last").before(s),s.data("username",t.name).data("oldname",t.name)})),"0"==fv.server.enabled?($("#enable-disable").addClass("alert-danger").removeClass("alert-success"),$("#vpn-status").text(window.msgs.disabled),$("#enable-vpn").removeClass("hidden")):($("#enable-disable").removeClass("alert-danger").addClass("alert-success"),$("#vpn-status").text(window.msgs.enabled),$("#disable-vpn").removeClass("hidden"),$("#restart-vpn").removeClass("hidden"),$("#vpn-settings").slideDown()),window.setInterval(function(){var e=$("#connect-vpn"),t=$("[name=cfg]",e).val();pcwrt.is_empty(t)||pcwrt.fetch_data(e.data("state_url"),{cfg:t},function(e){var t=null;$("#vpn-configs tr:gt(0)").find("td:first").removeClass("running connected stopped").each(function(){$(this).find("span.logs").hide(),$(this).text().trim()==e.cfg&&(t=$(this))}),t&&t.addClass(e.state).find("span.logs").show()})},1e4)});