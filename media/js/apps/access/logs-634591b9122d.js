function print_b(t){for(var a="",e=0;e<t.length;e++)if(/[\x20-\x7F]/.test(t.charAt(e)))a+=t.charAt(e);else{var n=t.charCodeAt(e).toString(16);a+=" "+(1==n.length?"0x0"+n:"0x"+n)+" "}return escapeXml(a)}function guess_protocol(t){var a=t.charCodeAt(0);if(22==a||23==a||21==a){if(3==t.charCodeAt(1)&&(1==t.charCodeAt(5)||0==t.charCodeAt(5))){if(0==t.charCodeAt(2))return"HTTPS (SSL 3.0)";if(1==t.charCodeAt(2))return"HTTPS (TLS 1.0)";if(2==t.charCodeAt(2))return"HTTPS (TLS 1.1)";if(3==t.charCodeAt(2))return"HTTPS (TLS 1.2)"}}else if(t.startsWith("HEAD")||t.startsWith("GET")||t.startsWith("POST")||t.startsWith("PUT")||t.startsWith("DELETE")||t.startsWith("TRACE")||t.startsWith("OPTIONS"))return"HTTP"}function new_slot_data(t){return{start:t.start,end:t.end,partial:1e3*t.end>plotter_state.now,visited:{cnt:0,entries:[]},blocked:{cnt:0,entries:[]}}}function add_slot_entry(t,a,e){var n=e.split("|"),r=/^P/.test(n[4])?t.visited:t.blocked;r.entries.push({profile:n[1],src:n[0],dst:n[2].trim(),port:n[3],time:a,code:n[4],data:n[5],sport:n[6]}),r.cnt++}function get_profile_name(t){return 0==(t=parseInt(t)-1)?window.msgs.default_profile_name:window.fv.profiles[t]}function prepare_reset(){$("#nav").data("range",null),$("#nav").data("blocked",null),$("#nav").data("plot_data",null),$("#nav ul").data("range",null),$("#nav ul").data("blocked",null)}function new_plot_details(){return{start:0,end:0,cnt:0,entries:[]}}function update_and_draw(t,n,a,e){var r=a.length,i=1;while(12<r)i*=2,r/=2;r=0;var s=[],d=new_plot_details();$.each(a,function(t,a){0==d.start&&(d.start=a.start);var e=a.start.toString();plotter_state.data[e]&&(n?(d.cnt+=plotter_state.data[e].blocked.cnt,d.entries.extend(plotter_state.data[e].blocked.entries)):(d.cnt+=plotter_state.data[e].visited.cnt,d.entries.extend(plotter_state.data[e].visited.entries))),++r==i&&(d.end=a.end,d.bar_cnt=d.cnt,d.bar_entries=d.entries,s.push(d),r=0,d=new_plot_details())}),0<r&&(d.end=a[a.length-1].end,d.bar_cnt=d.cnt,d.bar_entries=d.entries,s.push(d)),$("#nav").data("range",t),$("#nav").data("blocked",n),$("#nav").data("plot_data",s),e(s)}function prepare_data_and_draw(t,a,e){if($("#nav").data("range")!=t||$("#nav").data("blocked")!=a){var n=get_timeslots(t);fetch_data(get_fetch_slots(n),function(){update_and_draw(t,a,n,e)})}else e($("#nav").data("plot_data"))}function filter_data_by_profile_user(t,a,n){if(n&&0<n.length&&0<n[0].length){$.each(t,function(t,e){e.bar_cnt=0,e.bar_entries=[],$.each(e.entries,function(t,a){a.profile==n[0]&&(n.length<2||a.src==n[1])&&(e.bar_cnt++,e.bar_entries.push(a))})});var e=1<n.length?window.msgs.user+": "+n[1]:window.msgs.profile+": "+get_profile_name(n[0]);a&&(e+=" ("+window.msgs.blocked+")"),$(".chart h2,#raw-data h2").text(e)}else $.each(t,function(t,a){a.bar_cnt=a.cnt,a.bar_entries=a.entries}),$(".chart h2,#raw-data h2").text(a?window.msgs.all_blocked:window.msgs.all_visits)}function create_yscale(t){var a={10:[null,2,null,4,null,6,null,8,null,10],20:[null,4,null,8,null,12,null,16,null,20],40:[null,8,null,16,null,24,null,32,null,40],50:[null,10,null,20,null,30,null,40,null,50],75:[null,15,null,30,null,45,null,60,null,75],100:[null,20,null,40,null,60,null,80,null,100]},n=1;while(100<=t)t=(t+5)/10,n*=10;for(m in a)if(parseInt(m)>=t){t=m;break}return $(".numbers").empty(),$.each(a[t],function(t,a){var e=$("<li>").append($("<span>").text(a?n*a:""));a||e.css({width:"20px",left:"20px"}),$(".numbers").prepend(e)}),t*n}function draw_nav(t,e,n){if($("#nav ul").data("range")!=t||$("#nav ul").data("blocked")!=e){var r={count:0,profiles:[]},i={};$.each(n,function(t,a){$.each(a.entries,function(t,a){r.count++;var e=i[a.profile];e||(e={id:a.profile,name:get_profile_name(a.profile),count:0,users:{}},i[e.id]=e,r.profiles.push(e));var n=e.users[a.src];e.users[a.src]=n?n+1:1,e.count++})});var s=plotter_state.pu;if(s&&0<s.length&&0<s[0].length){var a=i[s[0]];a||(a={id:s[0],name:get_profile_name(s[0]),count:0,users:{}},r.profiles.push(a)),1<s.length&&!a.users[s[1]]&&(a.users[s[1]]=0)}$("#nav>ul").empty().append($("<li>").append($("<a>").attr("href","#").text("Total: "+r.count))),r.profiles.sort(function(t,a){return t.name.toUpperCase()>a.name.toUpperCase()?1:-1}),$.each(r.profiles,function(t,e){var a=!!(s&&0<s.length&&s[0]==e.id),n=$("<li>").append($("<a>").attr("href","#"+e.id).append($("<span>").addClass("glyphicon").addClass(a?"glyphicon-triangle-bottom":"glyphicon-triangle-right")).append(e.name+" ("+e.count+")")),r=$("<ul>").addClass("nav"),i=Object.keys(e.users).sort(function(t,a){return t.toUpperCase()>a.toUpperCase()?1:-1});$.each(i,function(t,a){r.append($("<li>").append($("<a>").attr("href","#"+e.id+"#"+a).text(a+" ("+e.users[a]+")")))}),$("#nav>ul").append(n.append(r))}),$("#nav>ul ul.nav").hide(),$("#nav>ul span.glyphicon-triangle-bottom").parents("a:first").next().show(),s&&(1==s.length?$("#nav>ul span.glyphicon-triangle-bottom").parents("li:first").addClass("active"):1<s.length&&$("#nav>ul ul a[href='#"+s[0]+"#"+s[1]+"']").parent().addClass("active")),$("#nav>ul a").on("click",function(t){t.preventDefault();var a=$(this).attr("href").substr(1).split("#");plotter_state.pu=a,$("#nav").find("li").removeClass("active"),$(this).parent().addClass("active"),get_raw_switch()?draw_raw_data(n,e):(draw_chart(n,e),draw_table(n,e))}),$("#nav>ul >li >a").on("click",function(){$("span",this).hasClass("glyphicon-triangle-right")?$(this).parent().find("ul").slideDown().end().find("span").removeClass("glyphicon-triangle-right").addClass("glyphicon-triangle-bottom"):$(this).parent().find("ul").slideUp().end().find("span").removeClass("glyphicon-triangle-bottom").addClass("glyphicon-triangle-right")}),$("#nav ul").data("range",t),$("#nav ul").data("blocked",e)}}function draw_chart(t,e){filter_data_by_profile_user(t,e,plotter_state.pu);var n=0;$.each(t,function(t,a){a.bar_cnt>n&&(n=a.bar_cnt)});var r=create_yscale(n),a,i=$(".bars").width()/t.length;$(".chart h4:first,#raw-data h4:first").html(format_date(t[0].start)+" &ndash; "+format_date(t[t.length-1].end)),$(".bars").empty(),$.each(t,function(t,a){var e=$("<div>").attr("data-percentage",100*a.bar_cnt/r).attr("data-value",a.bar_cnt).width(i-1).addClass("bar"),n=$("<span>").html(get_hm(a.start));$(".bars").append($("<li>").width(i).append(e).append(n))}),t.length%2==0&&$(".bars").append($("<li>").width(0).append($("<span>").html(get_hm(t[t.length-1].end)))),8<=t.length?($(".bars li:odd span").css("display","none"),$(".bars li:even span").css("left",function(){return 10*-$(this).text().indexOf(":")})):$(".bars li span").css("left",function(){return 10*-$(this).text().indexOf(":")}),hookup_left_right_events(t),$(".bars li .bar").each(function(t,a){$(this).animate({height:$(this).data("percentage")+"%"},1e3)}).on("click",function(t){var a;t.preventDefault(),t.stopPropagation(),draw_table([$("#nav").data("plot_data")[$(this).parent().index()]],e),$(this).addClass("active").parent().siblings().find(".bar").removeClass("active")}),$(".bars").on("click",function(t){t.stopPropagation(),draw_table($("#nav").data("plot_data"),e),$(this).find(".bar").removeClass("active")}),$(window).trigger("resize")}function draw_table(t,a){draw_summary_table(t),draw_block_summary(t,a)}function draw_summary_table(t){var s={},e=0;$.each(t,function(t,a){e+=a.cnt,$.each(a.bar_entries,function(t,a){var e;if(/^\d+\.\d+\.\d+\.\d+$/.test(a.dst))e=a.dst;else{var n=a.dst.split(".");e=2<=n.length?n[n.length-2]+"."+n[n.length-1]:n[0]}var r=a.dst+"#",i;(a.port?r+=("U"==a.code[1]?"UDP":"TCP")+":"+a.port:r+="N/A",s[e])?(s[e].cnt++,s[e].domains[r]?(s[e].domains[r].cnt++,s[e].domains[r][a.src]?s[e].domains[r][a.src]++:s[e].domains[r][a.src]=1):(s[e].domains[r]={cnt:1},s[e].domains[r][a.src]=1)):(s[e]={cnt:1,domains:{}},s[e].domains[r]={cnt:1},s[e].domains[r][a.src]=1)})});var n=$("#sites table:first");if(0!=e){n.show(),$("tbody",n).empty();var a=Object.keys(s).sort(function(t,a){return s[t].cnt>s[a].cnt?-1:s[t].cnt<s[a].cnt?1:t.toUpperCase()>a.toUpperCase()?1:-1});$.each(a,function(t,a){$("tbody",n).append('<tr><td><a href="#">'+a+"</a></td><td>"+s[a].cnt+"</td></tr>")}),$("thead th:eq(0)",n).width($("tbody tr:first td:eq(0)",n).width()),$("thead th:eq(1)",n).width($("tbody tr:first td:eq(1)",n).width()),$("tbody a").on("click",function(t){t.preventDefault(),t.stopPropagation();var r=$(this).text(),a=Object.keys(s[r].domains).sort(function(t,a){return s[r].domains[t].cnt>s[r].domains[a].cnt?-1:s[r].domains[t].cnt<s[r].domains[a].cnt?1:t.toUpperCase()>a.toUpperCase()?1:-1});$("#subdomains table tbody").empty(),$.each(a,function(t,n){var a=Object.keys(s[r].domains[n]).sort(function(t,a){return t.toUpperCase()>a.toUpperCase()?1:-1});$.each(a,function(t,a){if("cnt"!=a){var e=n.split("#");$("#subdomains table tbody").append("<tr><td>"+e[0]+"</td><td>"+e[1]+"</td><td>"+a+"</td><td>"+s[r].domains[n][a]+"</td></tr>")}})}),$("#subdomains").modal()})}else n.hide()}function draw_block_summary(t,a){var e=$("#sites table:eq(1)");if(a){var n=0,r={};if($.each(t,function(t,a){n+=a.cnt,$.each(a.bar_entries,function(t,a){var e=a.code[0];r[e]?r[e]++:r[e]=1})}),0!=n){var i=[];for(b in r)i.push(b);i.sort(function(t,a){return block_reason[t]>block_reason[a]?1:-1}),e.show(),$("tbody",e).empty(),$.each(i,function(t,a){$("tbody",e).append("<tr><td>"+block_reason[a]+"</td><td>"+r[a]+"</td></tr>")}),$("thead th:eq(0)",e).width($("tbody tr:first td:eq(0)",e).width()),$("thead th:eq(1)",e).width($("tbody tr:first td:eq(1)",e).width())}else e.hide()}else e.hide()}function resize_display(){if($("#raw-data").is(":visible")){var t=null;if($("#raw-blocked").is(":visible")&&(t=$("#raw-blocked")),$("#raw-visited").is(":visible")&&(t=$("#raw-visited")),!t)return;0<$("tbody tr:first",t).length&&$("thead th",t).each(function(t){$(this).width($(this).parent().parent().next().find("tr:first td:eq("+t+")").width())})}else if($(".chart").is(":visible")){var a=$(".bars").width(),e=$(".bars li").length;0==$(".bars li:last").width()&&e--;var n=a/e;$(".bars li").each(function(){0<$(this).width()&&$(this).width(n).find("div").width(n-1)}),9<=e?($(".bars li:odd span").css("display","none"),$(".bars li:even span").css("left",function(){return 10*-$(this).text().indexOf(":")})):$(".bars li span").css("left",function(){return 10*-$(this).text().indexOf(":")}),$("#sites table").each(function(){$("thead th:eq(0)",$(this)).width($("tbody tr:first td:eq(0)",$(this)).width()),$("thead th:eq(1)",$(this)).width($("tbody tr:first td:eq(1)",$(this)).width())})}}function draw_raw_data(t,a){if(filter_data_by_profile_user(t,a,plotter_state.pu),$(".chart h4:first,#raw-data h4:first").html(format_date(t[0].start)+" &ndash; "+format_date(t[t.length-1].end)),$("#raw-data table").hide(),pcwrt.showOverlay($("#spinner")),a){$("#raw-blocked tbody").empty();for(var e=t.length-1;0<=e;e--)for(var n,r=(n=t[e]).bar_entries.length-1;0<=r;r--){var i,s;(i=n.bar_entries[r]).port?(s=("U"==i.code[1]?"UDP":"TCP")+":"+i.port,0<i.sport&&(s+="/"+i.sport)):s="N/A",i.data&&(s='<a class="datalink" href="#" title="Data" data-bytes="'+i.data+'">'+s+"</a>"),$("#raw-blocked tbody").append("<tr><td>"+format_date(i.time,!0,!0)+"</td><td>"+i.dst+"</td><td>"+s+"</td><td>"+i.src+"</td><td>"+block_reason[i.code[0]]+"</td></tr>")}$("#raw-blocked").show(),resize_display()}else{$("#raw-visited tbody").empty();for(var e=t.length-1;0<=e;e--)for(var n,r=(n=t[e]).bar_entries.length-1;0<=r;r--){var i,s=("U"==(i=n.bar_entries[r]).code[1]?"UDP":"TCP")+":"+i.port;0<i.sport&&(s+="/"+i.sport),i.data&&(s='<a class="datalink" href="#" title="Data" data-bytes="'+i.data+'">'+s+"</a>"),$("#raw-visited tbody").append("<tr><td>"+format_date(i.time,!0,!0)+"</td><td>"+i.dst+"</td><td>"+s+"</td><td>"+i.src+"</td></tr>")}$("#raw-visited").show(),resize_display()}pcwrt.hideOverlay($("#spinner")),hookup_left_right_events(t)}function get_block_switch(){return"#blocked"==$("#block-switch li.active a").attr("href")}function redraw(){var a=get_block_switch(),e=get_raw_switch(),n=get_range(e);prepare_data_and_draw(n,a,function(t){draw_nav(n,a,t),e?($(".chart").hide(),$("#sites").hide(),$("#raw-data").show(),draw_raw_data(t,a)):($(".chart").show(),$("#sites").show(),$("#raw-data").hide(),draw_chart(t,a),draw_table(t,a))})}block_reason={A:"Ad",V:"TOR/VPN",T:"Calendar",D:"DNS",B:"Blocked",S:"Paused",L:"Proxy/IP",F:"Failed"},$(function(){$("#range li > a").on("click",function(t){t.preventDefault(),$(this).parent().hasClass("active")||($("#range li").removeClass("active"),$(this).parent().addClass("active"),redraw())}),$("#block-switch li > a").on("click",function(t){t.preventDefault(),$(this).parent().hasClass("active")||($("#block-switch li").removeClass("active"),$(this).parent().addClass("active"),redraw())}),$("#format-switch").on("change",function(){prepare_reset(),redraw()}),$("#raw-data").on("click","a.datalink",function(t){t.preventDefault();var a=$('<div class="modal-backdrop in"></div>');function e(){a.height($(window).height())}a.height($(window).height()),$(this).append(a),$(window).on("resize",e),$(this).on("click","div.modal-backdrop",function(t){t.preventDefault(),t.stopPropagation(),$(window).off("resize",e),$(this).parent().popover("destroy"),$(this).remove()});var n=atob($(this).data("bytes")),r=guess_protocol(n),i="<p><b>First 15 bytes:</b><br>"+print_b(n);r&&(i+="<br><br><b>Protocol:</b><br>"+r),i+="</p>",$(this).popover({content:i,html:!0,trigger:"manual",container:"body"}).popover("show")}),window.setInterval(function(){plotter_state.now=(new Date).getTime(),0<plotter_state.max_time&&plotter_state.max_time<plotter_state.now&&"hidden"==$(".canvas .right").css("visibility")&&$(".canvas .right").css("visibility","visible")},6e4),$(window).on("resize",function(){resize_display()}),plotter_state.now=(new Date).getTime(),plotter_state.plot_now=plotter_state.now,redraw()});