function new_slot_data(t){return{start:t.start,end:t.end,partial:1e3*t.end>plotter_state.now,down:0,up:0,entries:[],details:{}}}function add_slot_entry(t,e,a){var n=a.split("|");if(3==n.length)t.down+=parseInt(n[1]),t.up+=parseInt(n[2]),t.entries.push({user:n[0],down:parseInt(n[1]),up:parseInt(n[2]),time:e});else if(3<n.length){var r=n[0],s=t.details[r];s||(s=[],t.details[r]=s),s.push({domain:n[1],down:parseInt(n[2]),up:parseInt(n[3]),time:e})}}function new_plot_details(){return{start:0,end:0,down:0,up:0,entries:[],details:{}}}function prepare_reset(){}function update_and_draw(t,e,a){var n=e.length,r=1;while(12<n)r*=2,n/=2;n=0;var s=[],i=new_plot_details();$.each(e,function(t,e){0==i.start&&(i.start=e.start);var a=e.start.toString();plotter_state.data[a]&&(i.down+=plotter_state.data[a].down,i.up+=plotter_state.data[a].up,i.entries.extend(plotter_state.data[a].entries),$.each(plotter_state.data[a].details,function(t,e){i.details[t]?i.details[t].extend(e):i.details[t]=e})),++n==r&&(i.end=e.end,i.bar_down=i.down,i.bar_up=i.up,i.bar_entries=i.entries,s.push(i),n=0,i=new_plot_details())}),0<n&&(i.end=e[e.length-1].end,i.bar_down=i.down,i.bar_up=i.up,i.bar_entries=i.entries,s.push(i)),a(s)}function prepare_data_and_draw(t,e){var a=get_timeslots(t);fetch_data(get_fetch_slots(a),function(){update_and_draw(t,a,e)})}function create_yscale(n,t){var e={1:[null,.2,null,.4,null,.6,null,.8,null,1],2:[null,.4,null,.8,null,1.2,null,1.6,null,2],5:[null,1,null,2,null,3,null,4,null,5],10:[null,2,null,4,null,6,null,8,null,10],20:[null,4,null,8,null,12,null,16,null,20],50:[null,10,null,20,null,30,null,40,null,50],100:[null,20,null,40,null,60,null,80,null,100],200:[null,40,null,80,null,120,null,160,null,200],500:[null,100,null,200,null,300,null,400,null,500],1e3:[null,200,null,400,null,600,null,800,null,1e3],1200:[null,240,null,480,null,720,null,960,null,1200]},r=["Bytes","KB","MB","GB"],s=0,a=1;while(1024<t)t/=1024,a*=1024,s++;for(m in e)if(parseInt(m)>=t){t=m;break}return 1==a&&parseInt(t)<10&&(t="10"),n.empty(),$.each(e[t],function(t,e){var a=$("<li>").append($("<span>").text(e?e+" "+r[s]:""));e||a.css({width:"20px",left:"20px"}),n.prepend(a)}),{scale:a,unit:r[s],max:t*a}}function get_bar_text(t,e,a){return 1==e?t+" "+a:(t/e).toFixed(2)+" "+a}function get_display_bytes(t){var e=[" Bytes"," KB"," MB"," GB"],a=0;while(1024<t)if(t/=1024,3==++a)break;return(0<a?t.toFixed(2):t)+e[a]}function draw_chart(t,s,i){var a=0;$.each(t,function(t,e){0==i?e.bar_down>a&&(a=e.bar_down):e.bar_up>a&&(a=e.bar_up)});var l=create_yscale($(".numbers",s),a),e,d=$(".bars",s).width()/t.length;$("h4",s).html(format_date(t[0].start)+" &ndash; "+format_date(t[t.length-1].end)),$(".bars",s).data("scale",l.scale).data("unit",l.unit).empty(),$.each(t,function(t,e){var a=0==i?e.bar_down:e.bar_up,n=$("<div>").attr("data-percentage",100*a/l.max).attr("data-value",get_bar_text(a,l.scale,l.unit)).width(d-1).addClass("bar"),r=$("<span>").html(get_hm(e.start));$(".bars",s).append($("<li>").width(d).append(n).append(r))}),t.length%2==0&&$(".bars",s).append($("<li>").width(0).append($("<span>").html(get_hm(t[t.length-1].end)))),8<=t.length?($(".bars li:odd span",s).css("display","none"),$(".bars li:even span",s).css("left",function(){return 10*-$(this).text().indexOf(":")})):$(".bars li span",s).css("left",function(){return 10*-$(this).text().indexOf(":")})}function draw_charts(e){filter_data_by_user(e,plotter_state.pu),$(".chart").each(function(t){draw_chart(e,$(this),t)}),hookup_left_right_events(e),$(".bars li .bar").each(function(t,e){$(this).animate({height:$(this).data("percentage")+"%"},1e3)}).on("click",function(t){t.preventDefault(),t.stopPropagation();var e,a=get_pie_data([$("#nav").data("plot_data")[$(this).parent().index()]],plotter_state.pu),n=$(this).parents(".chart").index(".chart");draw_pie(a,$(".pie:eq("+n+")"),n),$(this).addClass("active").parent().siblings().find(".bar").removeClass("active")}),$(".bars").on("click",function(t){t.stopPropagation();var e,a=get_pie_data($("#nav").data("plot_data"),plotter_state.pu),n=$(this).parents(".chart").index(".chart");draw_pie(a,$(".pie:eq("+n+")"),n),$(this).find(".bar").removeClass("active")}),$(window).trigger("resize")}function filter_data_by_user(t,n){n&&0<n.length?($.each(t,function(t,a){a.bar_down=0,a.bar_up=0,a.bar_entries=[],$.each(a.entries,function(t,e){e.user==n&&(a.bar_down+=e.down,a.bar_up+=e.up,a.bar_entries.push(e))})}),$(".chart:first h2").text(n+" "+window.msgs.download),$(".chart:eq(1) h2").text(n+" "+window.msgs.upload)):($.each(t,function(t,e){e.bar_down=e.down,e.bar_up=e.up,e.bar_entries=e.entries}),$(".chart:first h2").text(window.msgs.total_download),$(".chart:eq(1) h2").text(window.msgs.total_upload))}function draw_nav(a){var n={bytes:0,users:{}};$("#nav").data("plot_data",a),$.each(a,function(t,e){$.each(e.entries,function(t,e){var a=e.down+e.up;n.bytes+=a,n.users[e.user]?n.users[e.user]+=a:n.users[e.user]=a})});var t=plotter_state.pu,e;t&&0<t.length&&(n.users[t]||(n.users[t]=0));$("#nav>ul").empty().append($("<li>").append($("<a>").attr("href","#").text("Total: "+get_display_bytes(n.bytes))));var r=Object.keys(n.users).sort(function(t,e){return t.toUpperCase()>e.toUpperCase()?1:-1});$.each(r,function(t,e){var a=$("<li>").addClass("chevron").append($("<a>").attr("href","#"+e).append(e+" ").append($("<span>").text("("+get_display_bytes(n.users[e])+")").css({"white-space":"nowrap"})));$("#nav>ul").append(a)}),t&&0<t.length&&$("#nav>ul a[href='#"+t+"']").parent().addClass("active"),$("#nav>ul a").on("click",function(t){t.preventDefault();var e=$(this).attr("href").substr(1);$("#nav").find("li").removeClass("active"),$(this).parent().addClass("active"),plotter_state.pu=e,draw_charts(a),draw_pies(a)})}function draw_pie(n,a,r){var l=0,d=0,t=0;if(!n||$.isEmptyObject(n.entries))return a.empty().prev().empty(),!1;var o=["#C8B769","#36B1C0","#ADF4D6","#CE5044","#044F55","#6882A3","#F6ED6E","#FE6847","#D4C5C0","#6D6905","#C6C9D0","#6783AF","#9F2820","#47BC85","#0064ea","#fafb93","#90c984","#ff58b0","#815451","#e69a9c","#4355c1","#f9ac74","#929fb0","#af7c4d","#e7bf79","#f4d6be","#5c3a4a"];function s(t){return 0==r?360*n.entries[t].down/n.down_total:360*n.entries[t].up/n.up_total}function e(t){return 0==r?360*(n.down_total-t)/n.down_total:360*(n.up_total-t)/n.up_total}function i(t,e,a,n){var r=[],s="width:"+t+"px;height:"+t+"px;position:absolute;clip:rect("+t/2+"px,"+t+"px,"+t+"px,0px);";a||(a=o[d%o.length],d++);while(180<e)r.push($("<div style='-moz-transform: rotate("+l+"deg);-webkit-transform: rotate("+l+"deg);"+s+"left:"+n+"px;'><div style='-moz-transform:rotate(0deg);-webkit-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);"+s+"border-radius:"+t+"px;box-shadow: inset 0 0 8px black;background:"+a+"'></div></div>")),e-=170,l+=170;var i=e-180;return r.push($("<div style='-moz-transform: rotate("+l+"deg);-webkit-transform: rotate("+l+"deg);"+s+"left:"+n+"px;'><div style='-moz-transform:rotate("+i+"deg);-webkit-transform:rotate("+i+"deg);-ms-transform:rotate("+i+"deg);transform:rotate("+i+"deg);"+s+"border-radius:"+t+"px;box-shadow :inset 0 0 8px black;background:"+a+"'></div></div>")),l+=e,r}a.empty().prev().empty();var u={};0==r?$.each(n.entries,function(t,e){5<=360*e.down/n.down_total&&(u[t]=1)}):$.each(n.entries,function(t,e){5<=360*e.up/n.up_total&&(u[t]=1)});var p=200<a.width()?200:a.width();a.height(p);var c=$("<ul>").css({"margin-left":(a.width()-p)/2}),h=0,w,_=Object.keys(u).sort(function(t,e){return t.toUpperCase()>e.toUpperCase()?1:-1}),f={};$.each(_,function(t,e){5<=(w=n.entries[e]?s(e):0)&&(a.append(i(p,w,o[t%o.length],(a.width()-p)/2)),f[e]={deg:w,color:o[t%o.length]},h+=0==r?n.entries[e].down:n.entries[e].up)});var b=a.parent().prev().find(".bars");return _=Object.keys(f).sort(function(t,e){return f[e].deg-f[t].deg}),$.each(_,function(t,e){var a=get_bar_text(0==r?n.entries[e].down:n.entries[e].up,b.data("scale"),b.data("unit"));c.append($("<li>").append($("<div>").attr("title",a).addClass("mark").css({"background-color":f[e].color})).append(e))}),0<(w=e(h))&&(a.append(i(p,w,"#DDD",(a.width()-p)/2)),c.append($("<li>").append($("<div>").addClass("mark").css({"background-color":"#DDD"})).append(window.msgs.others))),a.prev().append(c),!0}function get_pie_data(t,a){var n={down_total:0,up_total:0,entries:{}};return a&&0<a.length?$.each(t,function(t,e){$.each(e.details[a],function(t,e){n.down_total+=e.down,n.up_total+=e.up,n.entries[e.domain]||(n.entries[e.domain]={down:0,up:0}),n.entries[e.domain].down+=e.down,n.entries[e.domain].up+=e.up})}):$.each(t,function(t,e){$.each(e.entries,function(t,e){n.down_total+=e.down,n.up_total+=e.up,n.entries[e.user]||(n.entries[e.user]={down:0,up:0}),n.entries[e.user].down+=e.down,n.entries[e.user].up+=e.up})}),n}function draw_pies(t){var e=get_pie_data(t,plotter_state.pu);$(".pie").each(function(t){draw_pie(e,$(this),t)})}function resize_display(){$(".chart").each(function(){var t=$(this);if(t.is(":visible")){var e=$(".bars",t).width(),a=$(".bars li",t).length;0==$(".bars li:last").width()&&a--;var n=e/a;$(".bars li",t).each(function(){0<$(this).width()&&$(this).width(n).find("div").width(n-1)}),9<=a?($(".bars li:odd span",t).css("display","none"),$(".bars li:even span",t).css("left",function(){return 10*-$(this).text().indexOf(":")})):$(".bars li span",t).css("left",function(){return 10*-$(this).text().indexOf(":")})}});var t=$(".pielabel").width(),e=200<t?200:t;$(".pielabel ul").css({"margin-left":(t-e)/2}),$(".pie").height(e),$(".pie>div").css({left:(t-e)/2}),$(".pie div").width(e).height(e).css({clip:"rect("+e/2+"px,"+e+"px,"+e+"px,0px)"})}function redraw(){var t;prepare_data_and_draw(get_range(),function(t){$(".chart").show(),draw_nav(t),draw_charts(t),draw_pies(t)})}function showBandwidthMonitor(){$("#range li > a").on("click",function(t){t.preventDefault(),$(this).parent().hasClass("active")||($("#range li").removeClass("active"),$(this).parent().addClass("active"),redraw())}),window.setInterval(function(){plotter_state.now=(new Date).getTime(),0<plotter_state.max_time&&plotter_state.max_time<plotter_state.now&&"hidden"==$(".canvas .right").css("visibility")&&$(".canvas .right").css("visibility","visible")},6e4),$(window).on("resize",function(){resize_display()}),plotter_state.now=(new Date).getTime(),plotter_state.plot_now=plotter_state.now,redraw()}$(function(){$("#enable-bwmon").on("click",function(t){t.preventDefault();var e=$(this).parents("form");$("[name=enabled]",e).val("1"),pcwrt.submit_form(e,e.serialize(),function(t){$("#enable-disable").removeClass("alert-danger").addClass("alert-success"),$("#bwmon-status").text(window.msgs.enabled),$("#disable-bwmon").removeClass("hidden"),$("#enable-bwmon").addClass("hidden"),$("#logs-container").slideDown(400,showBandwidthMonitor)})}),$("#disable-bwmon").on("click",function(t){t.preventDefault();var e=$(this).parents("form");$("[name=enabled]",e).val("0"),pcwrt.submit_form(e,e.serialize(),function(t){$("#enable-disable").addClass("alert-danger").removeClass("alert-success"),$("#bwmon-status").text(window.msgs.disabled),$("#enable-bwmon").removeClass("hidden"),$("#disable-bwmon").addClass("hidden"),$("#logs-container").slideUp()})}),"1"!=fv.enabled?($("#enable-disable").addClass("alert-danger").removeClass("alert-success"),$("#bwmon-status").text(window.msgs.disabled),$("#enable-bwmon").removeClass("hidden")):($("#enable-disable").removeClass("alert-danger").addClass("alert-success"),$("#bwmon-status").text(window.msgs.enabled),$("#disable-bwmon").removeClass("hidden"),$("#logs-container").slideDown(400,showBandwidthMonitor))});