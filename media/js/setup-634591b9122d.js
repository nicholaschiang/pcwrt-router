function refresh_timezone(){$("input[value=filtered]","#timezone-group").prop("checked")?$("#zonename").updatecombo(window.filtered_timezones.map(function(e){return{text:e,value:e}})).val(fv.zonename):$("#zonename").updatecombo(window.all_timezones.map(function(e){return{text:e,value:e}})).val(fv.zonename)}function encryption_change(e){var a=e.val(),n=e.parents(".tab-pane:first");"none"==a?($(".key-div",n).slideUp(),$(".cipher-div",n).slideUp()):($(".cipher-div",n).slideDown(),$(".key-div",n).slideDown())}function checkPassword(){var e="";return $("#password1,#password2").parent().removeClass("has-error"),/^\s*$/.test($("#password1").val())?(e=window.msgs.enter_password,$("#password1").parent().addClass("has-error")):/^\s*$/.test($("#password2").val())?(e=window.msgs.confirm_password,$("#password2").parent().addClass("has-error")):$("#password1").val()!=$("#password2").val()&&(e=window.msgs.password_not_match,$("#password1,#password2").parent().addClass("has-error")),e}function checkWifi_tab(e){var a="",n=$("#wifi-panel .tab-pane:eq("+e.index()+")");if(n.data("disabled"))return null;if($("[name=ssid],[name=key]",n).parent().removeClass("has-error"),/^\s*$/.test($("[name=ssid]",n).val()))a=window.msgs.enter_ssid,$("[name=ssid]",n).parent().addClass("has-error");else if("none"!=$("[name=encryption]",n).val()){var t=$("[name=key]",n).val();(t.length<8||64<t.length||64==t.length&&!/^[0-9A-Fa-f]{64}$/.test(t))&&(a=window.msgs.enc_key_invalid,$("[name=key]",n).parent().addClass("has-error"))}return a}function checkWifi(){var e="",a;return $("#wifi-panel .nav-tabs li").each(function(){if(a=$("a",$(this)),e=checkWifi_tab($(this)))return a.tab("show"),!1}),e}function checkEmail(){var e="";return $("#email").parent().removeClass("has-error"),/^\s*$/.test($("#email").val())||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test($("#email").val())||(e=window.msgs.invalid_email,$("#email").parent().addClass("has-error")),e}function add_options(n,e){$.each(e,function(e,a){n.append($("<option/>").attr("value",a.value).text(a.text))})}var panels=["pwd","tz","wifi","email"],np=0;function displayPanel(e){e=e.replace(/set-(.*)-btn/,"$1");var a=$("#top-buttons").data("active"),n="";"pwd"==a?(n=checkPassword())&&(e="pwd"):"wifi"==a?(n=checkWifi())&&(e="wifi"):"email"==a&&(n=checkEmail())&&(e="email"),n?$("#error-msg").text(n).parent().removeClass("hidden"):$("#error-msg").text("").parent().addClass("hidden"),_displayPanel(e)}function _displayPanel(e){$("#top-buttons button").removeClass("btn-primary").addClass("btn-default"),$("#set-"+e+"-btn").removeClass("btn-default").addClass("btn-primary"),$(".setup-panel").addClass("hidden"),$("#"+e+"-panel").removeClass("hidden"),$("#action-panel button").addClass("hidden"),"pwd"==e?$("#next-btn").removeClass("hidden"):"tz"==e||"wifi"==e?($("#next-btn").removeClass("hidden"),$("#back-btn").removeClass("hidden")):"email"==e&&($("#back-btn").removeClass("hidden"),$("#finish-btn").removeClass("hidden")),$("#top-buttons").data("active",e);for(var a=0;a<panels.length;a++)if(panels[a]==e){np=a;break}}$("#wifi-panel").on("click",".disable-wifi",function(e){$(this).text()==window.msgs.disable?($(this).parent().siblings().hide(),$(this).text(window.msgs.enable),$(this).parent().next().show().next().show(),$(this).parent().parent().data("disabled",!0)):($(this).parent().siblings().show(),$(this).text(window.msgs.disable),$(this).parent().next().hide().next().hide(),$(this).parent().parent().data("disabled",!1))}),$("#back-btn").click(function(e){if(e.preventDefault(),0!=np){var a;if("wifi"==panels[np])if(1==$("#wifi-panel .tab-pane:visible").index())return $("#error-msg").text("").parent().addClass("hidden"),$("[name=ssid],[name=key]",$("#wifi-panel .tab-pane:eq(1)")).parent().removeClass("has-error"),void $("#wifi-panel .nav-tabs>li:first a").tab("show");displayPanel(panels[--np])}}),$("#next-btn").click(function(e){if(e.preventDefault(),np!=panels.length-1){var a;if("wifi"==panels[np])if(0==$("#wifi-panel .tab-pane:visible").index()){var n=checkWifi_tab($("#wifi-panel .nav-tabs li:first"));if(n)return void $("#error-msg").text(n).parent().removeClass("hidden");if($("#error-msg").text("").parent().addClass("hidden"),1<$("#wifi-panel .nav-tabs>li").length)return void $("#wifi-panel .nav-tabs>li:eq(1) a").tab("show")}displayPanel(panels[++np])}}),$("#top-buttons button").click(function(e){e.preventDefault(),displayPanel($(this).attr("id"))}),$("#finish-btn").click(function(e){e.preventDefault();var a="",n=checkPassword();if(n?a="pwd":(n=checkWifi())?a="wifi":(n=checkEmail())&&(a="email"),n)return $("#error-msg").text(n).parent().removeClass("hidden"),void _displayPanel(a);$("#error-msg").text("").parent().addClass("hidden"),$(this).parents("form").submit()}),$("input","#timezone-group").click(function(e){refresh_timezone()}),$(function(){for(var e=1;e<fv.devices.length;e++){var a=$("#wifi-panel .nav-tabs>li:first").clone();a.removeClass("active"),$("#wifi-panel .nav-tabs").append(a);var n=$("#wifi-panel .tab-content>div:first").clone();n.removeClass("in active"),$("#wifi-panel .tab-content").append(n)}1<fv.devices.length&&$("#wifi-panel .nav-tabs").show(),$.each(fv.devices,function(e,a){var n=$("#wifi-panel").find(".nav-tabs>li:eq("+e+") a").attr("href","#"+a.band.replace(/[^0-9a-zA-Z]/g,"-")).attr("aria-controls",a.band).text(a.band).end().find(".tab-pane:eq("+e+")").attr("id",a.band.replace(/[^0-9a-zA-Z]/g,"-"));n.data("name",a[".name"]),add_options($("[name=encryption]",n),a.encryptions),add_options($("[name=cipher]",n),a.ciphers),$("[name=ssid]",n).val(a.ssid),$("[name=encryption]",n).val(a.encryption),$("[name=cipher]",n).val(a.cipher),encryption_change($("[name=encryption]",n))}),$("[name=encryption]").change(function(){encryption_change($(this))}),$("select").makecombo(),$("input[type=password].reveal").reveal();var t=$("#fetch-timezones");pcwrt.fetch_data(t.attr("action"),"",function(e){window.all_timezones=e,$("[name=tz_offset]",t).val((new Date).stdTimezoneOffset()),$("[name=dst]",t).val((new Date).hasDst()),pcwrt.fetch_data(t.attr("action"),t.serialize(),function(e){window.filtered_timezones=e,refresh_timezone()})}),_displayPanel("pwd"),$("#setup-form").submit(function(e){e.preventDefault();var a=[];$("#wifi-panel .tab-pane").each(function(){var e={};e[".name"]=$(this).data("name"),$(this).data("disabled")?e.disabled=!0:(e.ssid=$("[name=ssid]",$(this)).val(),e.encryption=$("[name=encryption]",$(this)).val(),e.cipher=$("[name=cipher]",$(this)).val(),e.key=$("[name=key]",$(this)).val()),a.push(e)}),$("[name=devices]",this).val(JSON.stringify(a)),this.submit()})});